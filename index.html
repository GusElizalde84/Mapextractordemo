<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendaciones de Aarón</title>

  <!-- Tailwind CSS -->
  <script>tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel + html2pdf -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto', sans-serif; }
    .spinner { border: 4px solid #e0e0e0; border-top: 4px solid #1e88e5; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    .menu-panel { transform: translateX(-100%); transition: transform .3s ease; }
    .menu-panel.open { transform: translateX(0); }

    /* 🌙 Modo oscuro */
    .dark { background-color: #000; color: #fff; }
    .dark .bg-white { background-color: #111; }
    .dark input, .dark select { background-color: #222; color: #fff; border-color: #444; }
    .dark table { background-color: #000; }
    .dark table th { background-color: #1a1a1a; color: #fff; }
    .dark table td { background-color: #0d0d0d; color: #f2f2f2; }
    .dark .bg-blue-600 { background-color: #0057d9; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const API_BASE = "https://aaronbestplaces.vercel.app/api/lugares";

    const textos = {
      es: {
        title:"Recomendaciones de Aarón",
        city:"Ciudad",
        query:"Consulta",
        type:"Tipo de lugar",
        moreTypes:"Más categorías…",
        searchBtn:"Buscar lugares",
        minRating:"Calificación mínima ⭐",
        minReviews:"Reseñas mínimas 💬",
        all:"Todas",
        applyFilters:"Aplicar filtros",
        clearFilters:"🧹 Limpiar filtros",
        results:"RESULTADOS",
        exportPDF:"📄 Exportar a PDF",
        updating:"🔎 Consultando nuevos lugares en Google Maps…",
        filtersApplied:"✅ Filtros aplicados sobre los resultados actuales.",
        dataUpdated:"✅ Datos actualizados correctamente",
        lastUpdate:"Última actualización",
        noResults:"Sin resultados. Usa el buscador para traer datos de Google Maps.",
        footer_version:"Versión 50.1",
      }
    };

    const equivalencias = {
      "taqueria":["tacos","taquería","taquerías","taqueros"],
      "pizzeria":["pizza","pizzería","pizzerías"],
      "hamburguesas":["hamburguesas","burger","hamburguesería"],
      "sushi":["sushi","japonés","ramen"],
      "museos":["museo","galería","arte"]
    };

    const GENERIC_FOOD = ["tacos","pizza","sushi","mariscos","cafetería","restaurantes"];
    const GENERIC_LEISURE = ["bar","cantina","antro","discoteca","museo","cine","teatro"];
    const normalize = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    const expandQueryTerms = raw => {
      const base = normalize(raw||""); if(!base) return [];
      const set = new Set([base]);
      Object.values(equivalencias).forEach(arr=>{ if(arr.some(a=>a.includes(base))) arr.forEach(v=>set.add(v)); });
      return Array.from(set);
    };
    const priceToSymbol = n => n===1?"$":n===2?"$$":n===3?"$$$":n===4?"$$$$":"—";

    function App(){
      const [city,setCity]=useState("Ciudad de México");
      const [query,setQuery]=useState("");
      const [placeType,setPlaceType]=useState("");
      const [showMore,setShowMore]=useState(false);
      const [rows,setRows]=useState([]);
      const [minRating,setMinRating]=useState("");
      const [minReviews,setMinReviews]=useState("");
      const [tempMinRating,setTempMinRating]=useState("");
      const [tempMinReviews,setTempMinReviews]=useState("");
      const [message,setMessage]=useState("");
      const [loading,setLoading]=useState(false);
      const [lastUpdate,setLastUpdate]=useState("");

      async function fetchPlaces(q){
        setLoading(true);
        setMessage(textos.es.updating);
        try{
          const baseQuery = q.trim();
          let searchText = "";
          if(!baseQuery && placeType){
            // 🔧 Nueva lógica: si solo hay tipo, busca por ciudad y tipo
            searchText = city;
          } else {
            const terms = expandQueryTerms(baseQuery);
            const firstTerm = terms[0] || baseQuery;
            if(GENERIC_FOOD.includes(firstTerm)) searchText=`restaurantes de ${firstTerm} en ${city}`;
            else if(GENERIC_LEISURE.includes(firstTerm)) searchText=`lugares de ${firstTerm} en ${city}`;
            else searchText=`${firstTerm} en ${city}`;
          }

          const url = `${API_BASE}?q=${encodeURIComponent(searchText)}${placeType ? "&type="+encodeURIComponent(placeType):""}`;
          const res = await fetch(url);
          const json = await res.json();

          const data = (json.results||[]).map((p,i)=>({
            id:p.place_id||i,
            nombre:p.name||"-",
            calificacion:p.rating??"-",
            reseñas:p.user_ratings_total??0,
            precio:p.price_level??null,
            direccion:p.formatted_address||"-"
          }));

          setRows(data);
          setMessage(textos.es.dataUpdated);
          setLastUpdate(new Date().toLocaleString("es-MX"));
        }catch(e){
          setMessage("❌ Error al consultar la API");
        }finally{
          setLoading(false);
        }
      }

      const filtered = useMemo(()=>{
        return rows.filter(r=>{
          const passR = minRating?Number(r.calificacion)>=Number(minRating):true;
          const passC = minReviews?Number(r.reseñas)>=Number(minReviews):true;
          return passR && passC;
        });
      },[rows,minRating,minReviews]);

      return (
        <div className="min-h-screen">
          <header className="bg-blue-600 text-white px-4 py-3 flex items-center gap-3">
            <h1 className="text-lg font-bold">{textos.es.title}</h1>
          </header>

          {/* BLOQUE A: búsqueda */}
          <section className="max-w-6xl mx-auto mt-6 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-4">
              <h2 className="text-lg font-semibold text-blue-700">🔍 {textos.es.searchBtn}</h2>
              <div className="flex flex-col md:flex-row gap-3">
                <div className="w-full md:w-1/4">
                  <label className="block text-sm mb-1">{textos.es.city}</label>
                  <select value={city} onChange={e=>setCity(e.target.value)} className="border rounded-lg p-2 w-full">
                    <option>Ciudad de México</option>
                    <option>Guadalajara</option>
                    <option>Monterrey</option>
                  </select>
                </div>

                <div className="flex-1">
                  <label className="block text-sm mb-1">{textos.es.query}</label>
                  <input value={query} onChange={e=>setQuery(e.target.value)}
                    placeholder="Ej. tacos, museos, pizza..."
                    className="border rounded-lg p-2 w-full"/>
                </div>

                <div className="w-full md:w-64">
                  <label className="block text-sm mb-1">{textos.es.type}</label>
                  <select value={placeType} onChange={e=>setPlaceType(e.target.value)} className="border rounded-lg p-2 w-full">
                    <option value="">{textos.es.all}</option>
                    <option value="restaurant">🍽️ Restaurante</option>
                    <option value="cafe">☕ Cafetería</option>
                    <option value="bar">🍺 Bar / Cantina</option>
                    <option value="night_club">🍸 Antro / Club</option>
                    <option value="bakery">🥐 Panadería</option>
                    <option value="museum">🏛️ Museo</option>
                    <option value="art_gallery">🎨 Galería de arte</option>
                    <option value="tourist_attraction">🏞️ Atracción turística</option>
                    <option value="lodging">🏨 Hotel / Hospedaje</option>
                    <option value="shopping_mall">🛍️ Centro comercial</option>
                  </select>
                  <button onClick={()=>setShowMore(!showMore)} className="text-blue-600 underline mt-1 text-sm">{textos.es.moreTypes}</button>
                  {showMore && (
                    <div className="mt-2 grid grid-cols-2 gap-1 text-sm">
                      <button onClick={()=>setPlaceType("gym")} className="border p-1 rounded">💪 Gimnasio</button>
                      <button onClick={()=>setPlaceType("beauty_salon")} className="border p-1 rounded">💇‍♀️ Salón</button>
                      <button onClick={()=>setPlaceType("park")} className="border p-1 rounded">🏞️ Parque</button>
                      <button onClick={()=>setPlaceType("store")} className="border p-1 rounded">🏪 Tienda</button>
                      <button onClick={()=>setPlaceType("hospital")} className="border p-1 rounded">🏥 Hospital</button>
                      <button onClick={()=>setPlaceType("pharmacy")} className="border p-1 rounded">💊 Farmacia</button>
                      <button onClick={()=>setPlaceType("church")} className="border p-1 rounded">⛪ Iglesia</button>
                      <button onClick={()=>setPlaceType("bank")} className="border p-1 rounded">🏦 Banco</button>
                      <button onClick={()=>setPlaceType("airport")} className="border p-1 rounded">✈️ Aeropuerto</button>
                      <button onClick={()=>setPlaceType("bus_station")} className="border p-1 rounded">🚌 Terminal</button>
                    </div>
                  )}
                </div>

                <button onClick={()=>fetchPlaces(query)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                  {textos.es.searchBtn}
                </button>
              </div>
            </div>
          </section>

          {/* BLOQUE B: filtros */}
          <section className="max-w-6xl mx-auto mt-4 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-3">
              <h2 className="font-semibold text-gray-700">🧩 Filtros locales</h2>
              <div className="flex flex-col md:flex-row gap-3">
                <div>
                  <label className="block text-sm mb-1">{textos.es.minRating}</label>
                  <select value={tempMinRating} onChange={e=>setTempMinRating(e.target.value)} className="border rounded-lg p-2">
                    <option value="">{textos.es.all}</option>
                    <option value="4.0">4.0+</option>
                    <option value="4.3">4.3+</option>
                    <option value="4.5">4.5+</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">{textos.es.minReviews}</label>
                  <select value={tempMinReviews} onChange={e=>setTempMinReviews(e.target.value)} className="border rounded-lg p-2">
                    <option value="">{textos.es.all}</option>
                    <option value="1000">1,000+</option>
                    <option value="5000">5,000+</option>
                    <option value="10000">10,000+</option>
                  </select>
                </div>
                <div className="flex gap-2">
                  <button onClick={()=>{setMinRating(tempMinRating); setMinReviews(tempMinReviews); setMessage(textos.es.filtersApplied);}} className="px-3 py-2 border rounded-lg">{textos.es.applyFilters}</button>
                  <button onClick={()=>{setTempMinRating("");setTempMinReviews("");setMinRating("");setMinReviews("");setMessage(textos.es.filtersApplied);}} className="px-3 py-2 border rounded-lg">{textos.es.clearFilters}</button>
                </div>
              </div>
            </div>
          </section>

          <section className="max-w-6xl mx-auto mt-3 px-4">
            {loading && <div className="text-blue-700 bg-blue-50 border rounded p-2 text-sm">{textos.es.updating}</div>}
            {!loading && message && <div className="text-green-700 bg-green-50 border rounded p-2 text-sm">{message}</div>}
          </section>
{/* RESULTADOS */}
          <section id="results-section" className="max-w-6xl mx-auto mt-3 px-4 mb-10">
            <div className="bg-white rounded-xl shadow overflow-hidden">
              <div className="bg-blue-600 text-white px-4 py-3 flex justify-between items-center">
                <span>{textos.es.results}</span>
                <button
                  onClick={()=>{
                    const el=document.getElementById("results-section");
                    html2pdf().set({filename:"reporte.pdf"}).from(el).save();
                  }}
                  className="bg-white text-blue-700 px-3 py-1 rounded hover:bg-blue-50 text-sm font-semibold"
                >
                  {textos.es.exportPDF}
                </button>
              </div>

              <div className="p-4 overflow-x-auto">
                <table className="min-w-full text-sm border">
                  <thead className="bg-blue-100">
                    <tr>
                      <th className="border p-2 text-center">#</th>
                      <th className="border p-2 text-left">🏠 Lugar</th>
                      <th className="border p-2 text-center">⭐ Calificación</th>
                      <th className="border p-2 text-center">💲 Precio</th>
                      <th className="border p-2 text-center">💬 Reseñas</th>
                      <th className="border p-2 text-left">📍 Dirección</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.length>0?(
                      filtered.map((r,i)=>(
                        <tr key={i} className="hover:bg-blue-50">
                          <td className="border p-2 text-center">{i+1}</td>
                          <td className="border p-2">{r.nombre}</td>
                          <td className="border p-2 text-center">{r.calificacion}</td>
                          <td className="border p-2 text-center">{priceToSymbol(r.precio)}</td>
                          <td className="border p-2 text-center">{r.reseñas}</td>
                          <td className="border p-2">{r.direccion}</td>
                        </tr>
                      ))
                    ):(
                      <tr><td colSpan="6" className="text-center text-gray-500 p-4">{textos.es.noResults}</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            {lastUpdate && (
              <p className="text-gray-500 text-sm mt-3">{textos.es.lastUpdate}: {lastUpdate}</p>
            )}
          </section>

          {/* FOOTER */}
          <footer className="p-4 text-center text-gray-600 border-t border-gray-200">
            © 2025 Recomendaciones de Aarón — {textos.es.footer_version}
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>