<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendaciones de AarÃ³n</title>

  <!-- Tailwind (dark mode por clase) -->
  <script>tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel + html2pdf -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- Fuentes: Roboto + Noto Sans JP (japonÃ©s) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto','Noto Sans JP', system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    .menu-panel { transform: translateX(-100%); transition: transform .3s ease; }
    .menu-panel.open { transform: translateX(0); }

    /* ğŸŒ™ Modo oscuro con contraste alto */
    .dark { background-color: #000 !important; color: #fff !important; }
    .dark .bg-white { background-color: #111 !important; }
    .dark input, .dark select, .dark textarea { background-color: #222 !important; color: #fff !important; border-color: #444 !important; }
    .dark input::placeholder { color: #bbb !important; }
    .dark table { background-color: #000 !important; }
    .dark table th { background-color: #1a1a1a !important; color: #fff !important; border-color: #333 !important; }
    .dark table td { background-color: #0d0d0d !important; color: #f2f2f2 !important; border-color: #333 !important; }
    .dark .bg-blue-600 { background-color: #2563eb !important; color: #fff !important; }
    .dark .hover\:bg-blue-700:hover { background-color: #1e4ed8 !important; }
    .dark .text-blue-600 { color: #5ea0ff !important; }
    .dark .bg-blue-100 { background-color: #1a1a1a !important; }
    .dark .border { border-color: #333 !important; }
    .dark .hover\:bg-blue-50:hover { background-color: #222 !important; }
    .dark button { color: #fff !important; border-color: #333 !important; }
    .dark .bg-white.text-blue-700 { background-color: #333 !important; color: #fff !important; }

    /* Spinner circular */
    .spinner { width: 28px; height: 28px; border: 3px solid #93c5fd; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast centrado */
    .toast {
      position: fixed; left: 50%; top: 20%; transform: translate(-50%, -50%);
      background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; z-index: 60;
      box-shadow: 0 8px 24px rgba(0,0,0,.25); opacity: 0; animation: fade 2.4s ease forwards;
    }
    .toast.warn { background:#b91c1c; }
    @keyframes fade { 5% {opacity:1} 85% {opacity:1} 100%{opacity:0} }

    /* PDF sin cortes */
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    /* Overlay de "Generando PDFâ€¦" (fondo oscuro semitransparente) */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      display: flex; align-items: center; justify-content: center; z-index: 80;
    }
    .overlay-box {
      background: #111; color: #fff; padding: 18px 22px; border-radius: 12px;
      display: flex; align-items: center; gap: 12px; font-size: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .overlay .spinner { border-color:#60a5fa; border-top-color: transparent; }

    /* Selector de idioma (vertical) */
    .lang-item { border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; align-items:center; gap:12px; cursor:pointer; }
    .lang-item.active { border-color:#2563eb; background:#eef2ff; }
    .lang-flag { font-size: 22px; width:28px; text-align:center; }
    .lang-name { font-weight:600; }

    /* MenÃº de orden (popover) */
    .sort-pop { position:absolute; right:0; top:40px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.12); overflow:hidden; z-index:30; }
    .sort-pop button { display:flex; align-items:center; gap:8px; width:100%; text-align:left; padding:10px 12px; }
    .sort-pop button:hover { background:#f3f4f6; }
    .dark .sort-pop { background:#111; border-color:#333; }
    .dark .sort-pop button:hover { background:#1f2937; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const API_BASE = "https://aaronbestplaces.vercel.app/api/lugares";
    const HEADER_LOGO_SRC = "logo.png";

    /* ======= Textos ======= */
    const TEXTS = {
      es: {
        title:"Recomendaciones de AarÃ³n",
        menu_title:"MenÃº",
        menu_home:"ğŸ  Inicio", menu_reports:"ğŸ“Š Reportes", menu_help:"â“ Ayuda", menu_access:"ğŸŒ Accesibilidad", menu_about:"â„¹ï¸ Acerca de",
        city:"Ciudad", query:"Consulta", type:"Tipo de lugar", moreTypes:"MÃ¡s categorÃ­asâ€¦", searchBtn:"Buscar lugares",
        minRating:"CalificaciÃ³n mÃ­nima â­", minReviews:"ReseÃ±as mÃ­nimas ğŸ’¬", all:"Todas", applyFilters:"Aplicar filtros", clearFilters:"ğŸ§¹ Limpiar todo",
        results:"RESULTADOS", exportPDF:"ğŸ“„ Exportar a PDF",
        updating:"ğŸ” Consultando nuevos lugares en Google Mapsâ€¦", filtersApplied:"âœ… Filtros aplicados sobre los resultados actuales.",
        dataUpdated:"âœ… Datos actualizados correctamente", lastUpdate:"Ãšltima actualizaciÃ³n",
        noResults:"Sin resultados. Usa el buscador para traer datos de Google Maps.",
        help_title:"Ayuda",
        help_text:"1) En â€˜Buscar lugaresâ€™, escribe el nombre o palabra (opcional: selecciona â€˜Tipo de lugarâ€™) y la ciudad; presiona â€˜Buscar lugaresâ€™. 2) En â€˜Filtrosâ€™, ajusta calificaciÃ³n y reseÃ±as y presiona â€˜Aplicar filtrosâ€™. 3) Exporta a PDF en el encabezado de resultados.",
        close:"Cerrar", about_title:"Acerca de", about_line1:"Una aplicaciÃ³n para los mejores guÃ­as Edith y AarÃ³n", about_line2:"De sus amigos Lili y Gus",
        access_title:"Accesibilidad", access_select:"Selecciona tu idioma", access_es:"EspaÃ±ol", access_en:"English", access_fr:"FranÃ§ais", access_pt:"PortuguÃªs", access_ja:"æ—¥æœ¬èª",
        access_theme:"Modo oscuro", reports_title:"Reportes", reports_line1:"PrÃ³ximamente habrÃ¡ novedades en esta secciÃ³n.", reports_line2:"Â¡Estamos trabajando para ofrecerte reportes y estadÃ­sticas personalizadas!",
        info_title:"Detalles del lugar", info_rating:"CalificaciÃ³n", info_reviews:"ReseÃ±as", info_price:"Precio", info_address:"DirecciÃ³n", info_phone:"TelÃ©fono", info_hours:"Horario", info_map:"Abrir en Google Maps",
        footer_version:"VersiÃ³n 51.0", expanded_prefix:"ğŸ” BÃºsqueda ampliada:", results_count:"lugares encontrados",
        pdf_city:"Ciudad", pdf_rating:"CalificaciÃ³n", pdf_reviews:"ReseÃ±as", pdf_type:"Tipo", pdf_open:"Abrir",
        pdf_generated:"Generado con Recomendaciones de AarÃ³n v51.0",
        pdf_generating:"ğŸ“„ Generando PDFâ€¦",
        loading_more:"â³ Cargando mÃ¡s resultados ({cur} de {tot})â€¦",
        sort_tooltip:"Ordenar",
        sort_rating:"â­ CalificaciÃ³n",
        sort_reviews:"ğŸ’¬ ReseÃ±as",
        sort_price:"ğŸ’² Precio",
        sorted_by_rating:"Ordenado por calificaciÃ³n",
        sorted_by_reviews:"Ordenado por reseÃ±as",
        sorted_by_price:"Ordenado por precio"
      },
      en: {
        title:"Aaronâ€™s Recommendations",
        menu_title:"Menu",
        menu_home:"ğŸ  Home", menu_reports:"ğŸ“Š Reports", menu_help:"â“ Help", menu_access:"ğŸŒ Accessibility", menu_about:"â„¹ï¸ About",
        city:"City", query:"Query", type:"Place type", moreTypes:"More categoriesâ€¦", searchBtn:"Search places",
        minRating:"Min rating â­", minReviews:"Min reviews ğŸ’¬", all:"All", applyFilters:"Apply filters", clearFilters:"ğŸ§¹ Clear all",
        results:"RESULTS", exportPDF:"ğŸ“„ Export to PDF",
        updating:"ğŸ” Fetching new places from Google Mapsâ€¦", filtersApplied:"âœ… Filters applied to current results.",
        dataUpdated:"âœ… Data updated successfully", lastUpdate:"Last update",
        noResults:"No results. Use the search to fetch data from Google Maps.",
        help_title:"Help",
        help_text:"1) In 'Search places', type a name or keyword (optional: select 'Place type') and the city; press 'Search places'. 2) In 'Filters', adjust rating and reviews and press 'Apply filters'. 3) Export to PDF at the results header.",
        close:"Close", about_title:"About", about_line1:"An app for the best guides Edith and AarÃ³n", about_line2:"From their friends Lili and Gus",
        access_title:"Accessibility", access_select:"Select your language", access_es:"Spanish", access_en:"English", access_fr:"French", access_pt:"Portuguese", access_ja:"Japanese",
        access_theme:"Dark mode", reports_title:"Reports", reports_line1:"New features coming soon to this section.", reports_line2:"We are working on personalized reports and statistics!",
        info_title:"Place details", info_rating:"Rating", info_reviews:"Reviews", info_price:"Price", info_address:"Address", info_phone:"Phone", info_hours:"Hours", info_map:"Open in Google Maps",
        footer_version:"Version 51.0", expanded_prefix:"ğŸ” Expanded search:", results_count:"places found",
        pdf_city:"City", pdf_rating:"Rating", pdf_reviews:"Reviews", pdf_type:"Type", pdf_open:"Open",
        pdf_generated:"Generated with Aaronâ€™s Recommendations v51.0",
        pdf_generating:"ğŸ“„ Generating PDFâ€¦",
        loading_more:"â³ Loading more results ({cur} of {tot})â€¦",
        sort_tooltip:"Sort",
        sort_rating:"â­ Rating",
        sort_reviews:"ğŸ’¬ Reviews",
        sort_price:"ğŸ’² Price",
        sorted_by_rating:"Sorted by rating",
        sorted_by_reviews:"Sorted by reviews",
        sorted_by_price:"Sorted by price"
      },
      fr: {
        title:"Recommandations dâ€™AarÃ³n",
        menu_title:"Menu",
        menu_home:"ğŸ  Accueil", menu_reports:"ğŸ“Š Rapports", menu_help:"â“ Aide", menu_access:"ğŸŒ AccessibilitÃ©", menu_about:"â„¹ï¸ Ã€ propos",
        city:"Ville", query:"Recherche", type:"Type de lieu", moreTypes:"Plus de catÃ©goriesâ€¦", searchBtn:"Rechercher",
        minRating:"Note minimale â­", minReviews:"Avis minimum ğŸ’¬", all:"Toutes", applyFilters:"Appliquer les filtres", clearFilters:"ğŸ§¹ Tout effacer",
        results:"RÃ‰SULTATS", exportPDF:"ğŸ“„ Exporter en PDF",
        updating:"ğŸ” RÃ©cupÃ©ration de nouveaux lieux sur Google Mapsâ€¦", filtersApplied:"âœ… Filtres appliquÃ©s aux rÃ©sultats actuels.",
        dataUpdated:"âœ… DonnÃ©es mises Ã  jour", lastUpdate:"DerniÃ¨re mise Ã  jour",
        noResults:"Aucun rÃ©sultat. Utilisez la recherche pour rÃ©cupÃ©rer des donnÃ©es de Google Maps.",
        help_title:"Aide",
        help_text:"1) Dans â€˜Rechercherâ€™, saisissez un nom ou mot-clÃ© (option : sÃ©lectionnez le type) et la ville ; cliquez sur â€˜Rechercherâ€™. 2) Dans â€˜Filtresâ€™, ajustez la note et les avis puis â€˜Appliquerâ€™. 3) Exporte en PDF dans lâ€™en-tÃªte des rÃ©sultats.",
        close:"Fermer", about_title:"Ã€ propos", about_line1:"Une application pour les meilleurs guides Edith et AarÃ³n", about_line2:"De leurs amis Lili et Gus",
        access_title:"AccessibilitÃ©", access_select:"Choisissez votre langue", access_es:"Espagnol", access_en:"Anglais", access_fr:"FranÃ§ais", access_pt:"Portugais", access_ja:"Japonais",
        access_theme:"Mode sombre", reports_title:"Rapports", reports_line1:"NouveautÃ©s Ã  venir dans cette section.", reports_line2:"Nous prÃ©parons des rapports et statistiques personnalisÃ©s !",
        info_title:"DÃ©tails du lieu", info_rating:"Note", info_reviews:"Avis", info_price:"Prix", info_address:"Adresse", info_phone:"TÃ©lÃ©phone", info_hours:"Horaires", info_map:"Ouvrir dans Google Maps",
        footer_version:"Version 51.0", expanded_prefix:"ğŸ” Recherche Ã©tendue :", results_count:"lieux trouvÃ©s",
        pdf_city:"Ville", pdf_rating:"Note", pdf_reviews:"Avis", pdf_type:"Type", pdf_open:"Ouvrir",
        pdf_generated:"GÃ©nÃ©rÃ© avec Recommandations dâ€™AarÃ³n v51.0",
        pdf_generating:"ğŸ“„ GÃ©nÃ©ration du PDFâ€¦",
        loading_more:"â³ Chargement de plus de rÃ©sultats ({cur} sur {tot})â€¦",
        sort_tooltip:"Trier",
        sort_rating:"â­ Note",
        sort_reviews:"ğŸ’¬ Avis",
        sort_price:"ğŸ’² Prix",
        sorted_by_rating:"TriÃ© par note",
        sorted_by_reviews:"TriÃ© par avis",
        sorted_by_price:"TriÃ© par prix"
      },
      pt: {
        title:"RecomendaÃ§Ãµes do AarÃ³n",
        menu_title:"Menu",
        menu_home:"ğŸ  InÃ­cio", menu_reports:"ğŸ“Š RelatÃ³rios", menu_help:"â“ Ajuda", menu_access:"ğŸŒ Acessibilidade", menu_about:"â„¹ï¸ Sobre",
        city:"Cidade", query:"Consulta", type:"Tipo de lugar", moreTypes:"Mais categoriasâ€¦", searchBtn:"Buscar lugares",
        minRating:"AvaliaÃ§Ã£o mÃ­nima â­", minReviews:"MÃ­nimo de avaliaÃ§Ãµes ğŸ’¬", all:"Todas", applyFilters:"Aplicar filtros", clearFilters:"ğŸ§¹ Limpar tudo",
        results:"RESULTADOS", exportPDF:"ğŸ“„ Exportar para PDF",
        updating:"ğŸ” Buscando novos lugares no Google Mapsâ€¦", filtersApplied:"âœ… Filtros aplicados aos resultados atuais.",
        dataUpdated:"âœ… Dados atualizados com sucesso", lastUpdate:"Ãšltima atualizaÃ§Ã£o",
        noResults:"Sem resultados. Use a busca para trazer dados do Google Maps.",
        help_title:"Ajuda",
        help_text:"1) Em â€˜Buscar lugaresâ€™, digite um nome ou palavra (opcional: selecione â€˜Tipo de lugarâ€™) e a cidade; clique em â€˜Buscar lugaresâ€™. 2) Em â€˜Filtrosâ€™, ajuste avaliaÃ§Ã£o e avaliaÃ§Ãµes e clique em â€˜Aplicar filtrosâ€™. 3) Exporte em PDF no cabeÃ§alho dos resultados.",
        close:"Fechar", about_title:"Sobre", about_line1:"Um app para os melhores guias Edith e AarÃ³n", about_line2:"De seus amigos Lili e Gus",
        access_title:"Acessibilidade", access_select:"Selecione seu idioma", access_es:"Espanhol", access_en:"InglÃªs", access_fr:"FrancÃªs", access_pt:"PortuguÃªs", access_ja:"JaponÃªs",
        access_theme:"Modo escuro", reports_title:"RelatÃ³rios", reports_line1:"Novidades em breve nesta seÃ§Ã£o.", reports_line2:"Trabalhamos em relatÃ³rios e estatÃ­sticas personalizadas!",
        info_title:"Detalhes do local", info_rating:"AvaliaÃ§Ã£o", info_reviews:"AvaliaÃ§Ãµes", info_price:"PreÃ§o", info_address:"EndereÃ§o", info_phone:"Telefone", info_hours:"HorÃ¡rio", info_map:"Abrir no Google Maps",
        footer_version:"VersÃ£o 51.0", expanded_prefix:"ğŸ” Busca ampliada:", results_count:"locais encontrados",
        pdf_city:"Cidade", pdf_rating:"AvaliaÃ§Ã£o", pdf_reviews:"AvaliaÃ§Ãµes", pdf_type:"Tipo", pdf_open:"Abrir",
        pdf_generated:"Gerado com RecomendaÃ§Ãµes do AarÃ³n v51.0",
        pdf_generating:"ğŸ“„ Gerando PDFâ€¦",
        loading_more:"â³ Carregando mais resultados ({cur} de {tot})â€¦",
        sort_tooltip:"Ordenar",
        sort_rating:"â­ AvaliaÃ§Ã£o",
        sort_reviews:"ğŸ’¬ AvaliaÃ§Ãµes",
        sort_price:"ğŸ’² PreÃ§o",
        sorted_by_rating:"Ordenado por avaliaÃ§Ã£o",
        sorted_by_reviews:"Ordenado por avaliaÃ§Ãµes",
        sorted_by_price:"Ordenado por preÃ§o"
      },
      ja: {
        title:"ã‚¢ãƒ­ãƒ³ã®ãŠã™ã™ã‚",
        menu_title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
        menu_home:"ğŸ  ãƒ›ãƒ¼ãƒ ", menu_reports:"ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ", menu_help:"â“ ãƒ˜ãƒ«ãƒ—", menu_access:"ğŸŒ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£", menu_about:"â„¹ï¸ ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦",
        city:"éƒ½å¸‚", query:"æ¤œç´¢èª", type:"æ–½è¨­ã‚¿ã‚¤ãƒ—", moreTypes:"ãã®ä»–ã®ã‚«ãƒ†ã‚´ãƒªâ€¦", searchBtn:"å ´æ‰€ã‚’æ¤œç´¢",
        minRating:"æœ€å°è©•ä¾¡ â­", minReviews:"æœ€å°ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° ğŸ’¬", all:"ã™ã¹ã¦", applyFilters:"ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨", clearFilters:"ğŸ§¹ ã™ã¹ã¦ã‚¯ãƒªã‚¢",
        results:"çµæœ", exportPDF:"ğŸ“„ PDFã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
        updating:"ğŸ” Googleãƒãƒƒãƒ—ã‹ã‚‰æ–°ã—ã„å ´æ‰€ã‚’å–å¾—ä¸­â€¦", filtersApplied:"âœ… ç¾åœ¨ã®çµæœã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚",
        dataUpdated:"âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ", lastUpdate:"æœ€çµ‚æ›´æ–°",
        noResults:"çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢ã—ã¦Googleãƒãƒƒãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚",
        help_title:"ãƒ˜ãƒ«ãƒ—",
        help_text:"1)ã€Œå ´æ‰€ã‚’æ¤œç´¢ã€ã§åå‰ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼šæ–½è¨­ã‚¿ã‚¤ãƒ—ï¼‰ã¨éƒ½å¸‚ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã€‚2)ã€Œãƒ•ã‚£ãƒ«ã‚¿ã€ã§è©•ä¾¡ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã‚’èª¿æ•´ã—ã¦é©ç”¨ã€‚3) çµæœãƒ˜ãƒƒãƒ€ã‹ã‚‰PDFã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‚",
        close:"é–‰ã˜ã‚‹", about_title:"ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦", about_line1:"æœ€é«˜ã®ã‚¬ã‚¤ãƒ‰ã€Edith ã¨ AarÃ³n ã®ãŸã‚ã®ã‚¢ãƒ—ãƒª", about_line2:"å‹äºº Lili ã¨ Gus ã‚ˆã‚Š",
        access_title:"ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£", access_select:"è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„", access_es:"ã‚¹ãƒšã‚¤ãƒ³èª", access_en:"è‹±èª", access_fr:"ãƒ•ãƒ©ãƒ³ã‚¹èª", access_pt:"ãƒãƒ«ãƒˆã‚¬ãƒ«èª", access_ja:"æ—¥æœ¬èª",
        access_theme:"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰", reports_title:"ãƒ¬ãƒãƒ¼ãƒˆ", reports_line1:"ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è¿‘æ—¥å…¬é–‹äºˆå®šã§ã™ã€‚", reports_line2:"ãƒ¬ãƒãƒ¼ãƒˆã¨çµ±è¨ˆæ©Ÿèƒ½ã‚’æº–å‚™ä¸­ï¼",
        info_title:"æ–½è¨­ã®è©³ç´°", info_rating:"è©•ä¾¡", info_reviews:"ãƒ¬ãƒ“ãƒ¥ãƒ¼", info_price:"ä¾¡æ ¼å¸¯", info_address:"ä½æ‰€", info_phone:"é›»è©±", info_hours:"å–¶æ¥­æ™‚é–“", info_map:"Googleãƒãƒƒãƒ—ã§é–‹ã",
        footer_version:"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 51.0", expanded_prefix:"ğŸ” æ‹¡å¼µæ¤œç´¢ï¼š", results_count:"ä»¶",
        pdf_city:"éƒ½å¸‚", pdf_rating:"è©•ä¾¡", pdf_reviews:"ãƒ¬ãƒ“ãƒ¥ãƒ¼", pdf_type:"ã‚¿ã‚¤ãƒ—", pdf_open:"é–‹ã",
        pdf_generated:"ã‚¢ãƒ­ãƒ³ã®ãŠã™ã™ã‚ v51.0 ã«ã‚ˆã‚Šç”Ÿæˆ",
        pdf_generating:"ğŸ“„ PDFã‚’ç”Ÿæˆä¸­â€¦",
        loading_more:"â³ ã•ã‚‰ã«çµæœã‚’èª­ã¿è¾¼ã¿ä¸­ ({cur} / {tot})â€¦",
        sort_tooltip:"ä¸¦ã¹æ›¿ãˆ",
        sort_rating:"â­ è©•ä¾¡",
        sort_reviews:"ğŸ’¬ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°",
        sort_price:"ğŸ’² ä¾¡æ ¼",
        sorted_by_rating:"è©•ä¾¡ã§ä¸¦ã¹æ›¿ãˆ",
        sorted_by_reviews:"ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã§ä¸¦ã¹æ›¿ãˆ",
        sorted_by_price:"ä¾¡æ ¼ã§ä¸¦ã¹æ›¿ãˆ"
      }
    };

    /* ======= Equivalencias (comida + ocio + cultura) ======= */
    const equivalencias = {
      "taqueria":["tacos","taquerÃ­a","taquerÃ­as","taqueros"],
      "pizzeria":["pizza","pizzerÃ­a","pizzerÃ­as","pizzeria","pizzerias"],
      "hamburguesas":["hamburguesas","burger","hamburgueserÃ­a","hamburgueserias"],
      "sushi":["sushi","restaurante japonÃ©s","comida japonesa","ramen","izakaya","yakitori"],
      "mariscos":["mariscos","pescados","marisquerÃ­a","marisquerÃ­as"],
      "cafe":["cafÃ©","cafeterÃ­a","coffee shop","cafÃ©s de especialidad","barista"],
      "comida mexicana":["comida mexicana","antojitos","tacos","cocina mexicana"],
      "comida italiana":["comida italiana","trattoria","pasta","pizza"],
      "comida china":["comida china","chow mein","arroz frito","dim sum"],
      "comida americana":["comida americana","hamburguesas","bbq","alitas","hot dogs"],
      "comida india":["comida india","curry","masala","tandoori","hindÃº"],
      "comida vegana":["vegano","vegana","vegetariano","vegetariana","plant based","plant-based","saludable"],
      "postres":["postres","reposterÃ­a","pastelerÃ­a","dulces"],
      "bares":["bar","cantina","cervecerÃ­a","pub","mixologÃ­a","coctelerÃ­a"],
      "antros":["antro","discoteca","club nocturno","nightclub","dance club","disco"],
      "discos":["disco","discoteca","club","fiesta","dance floor"],
      "museos":["museo","galerÃ­a","galeria","exposiciÃ³n","exhibiciÃ³n","arte"]
    };

    const GENERIC_FOOD = ["tacos","taqueria","taquerÃ­a","taquerÃ­as","taqueros","pizza","pizzeria","pizzerÃ­a","pizzerÃ­as","hamburguesas","sushi","mariscos","cafe","cafeteria","cafeterÃ­a","antojitos","restaurantes","carnes","postres","panaderia","panaderÃ­a","vegano","vegetariano","pasta","italiana","china","india","americana","mexicana","ramen","bbq","alitas","hot dogs"];
    const GENERIC_LEISURE = ["bares","bar","cantina","cerveceria","cervecerÃ­a","pub","pubs","antros","antro","discoteca","discotecas","discos","club","club nocturno","nightclub","museos","museo","galeria","galerÃ­a","cine","teatro","exposiciÃ³n","exhibiciÃ³n","arte"];

    const normalize = (s)=> (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    const looksGeneric = (term) => /^[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+$/.test(term.trim());
    const priceToSymbol = (lvl) => { const n = Number(lvl); return n===1 ? "$" : n===2 ? "$$" : n===3 ? "$$$" : n===4 ? "$$$$" : "â€”"; };

    function expandQueryTerms(raw){
      const base=normalize(raw||""); if(!base) return [];
      const set=new Set([base, ...base.split(/\s+/)]);
      const groups=Object.entries(equivalencias).map(([k,a])=>[normalize(k),...a.map(normalize)]);
      let changed=true, i=0;
      while(changed && i<2){changed=false; i++;
        for(const t of Array.from(set)){
          for(const g of groups){
            if(g.some(x=>t.includes(x) || x.includes(t))){
              for(const w of g){ if(!set.has(w)){ set.add(w); changed=true; } }
            }
          }
        }
      }
      return Array.from(set);
    }

    function isLikelyProperName(raw){
      const str = (raw||"").trim();
      if(!str) return false;
      const hasCaps = /[A-ZÃÃ‰ÃÃ“ÃšÃ‘]/.test(raw);
      const hasQuotes = /["'â€™]/.test(raw);
      const words = str.split(/\s+/);
      const normWords = words.map(normalize);
      const inGeneric = normWords.some(w => GENERIC_FOOD.includes(w) || GENERIC_LEISURE.includes(w));
      const twoWordsNotGeneric = words.length >= 2 && !inGeneric;
      return hasCaps || hasQuotes || twoWordsNotGeneric;
    }

    const TYPE_TO_KEYWORD = {
      lodging: "hoteles", restaurant: "restaurantes", cafe: "cafeterÃ­as", bar: "bares",
      night_club: "antros", gym: "gimnasios", museum: "museos", art_gallery: "galerÃ­as de arte",
      tourist_attraction: "atracciones turÃ­sticas", shopping_mall: "centros comerciales",
      bakery: "panaderÃ­as", meal_takeaway: "comida para llevar", meal_delivery: "comida a domicilio",
      park: "parques", store: "tiendas", supermarket: "supermercados", gas_station: "gasolineras",
      pharmacy: "farmacias", hospital: "hospitales", church: "iglesias", bank: "bancos", atm: "cajeros",
      car_repair: "talleres mecÃ¡nicos", car_rental: "renta de autos", airport: "aeropuertos",
      bus_station: "terminales de autobuses", train_station: "estaciones de tren",
      electronics_store: "tiendas de electrÃ³nica", movie_theater: "cines"
    };

    function buildPdfLogoDataURL() {
      const canvas = document.createElement("canvas");
      canvas.width = 900; canvas.height = 140;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#000000";
      ctx.font = "bold 52px Arial, Helvetica, 'Noto Sans JP', sans-serif";
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText("Recomendaciones de AarÃ³n", canvas.width/2, canvas.height/2);
      return canvas.toDataURL("image/png");
    }

    const PLACEHOLDER_IMG = "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='18' fill='#6b7280'>ğŸ™ï¸</text></svg>`);

    function App(){
      const savedLang = typeof localStorage !== "undefined" ? localStorage.getItem("aaron_lang") : null;
      const [lang,setLang]=useState(savedLang || "es");
      const [dark,setDark]=useState(false);
      const [openMenu,setOpenMenu]=useState(false);
      const [openHelp,setOpenHelp]=useState(false);
      const [openAbout,setOpenAbout]=useState(false);
      const [openReports,setOpenReports]=useState(false);
      const [openAccess,setOpenAccess]=useState(false);
      const [infoRow,setInfoRow]=useState(null);

      // BÃºsqueda
      const [city,setCity]=useState("Ciudad de MÃ©xico");
      const [query,setQuery]=useState("");
      const [placeType,setPlaceType]=useState("");
      const [showMoreTypes,setShowMoreTypes]=useState(false);

      // Datos
      const [rows,setRows]=useState([]);
      const [loading,setLoading]=useState(false);
      const [message,setMessage]=useState("");
      const [toast,setToast]=useState("");
      const [lastUpdate,setLastUpdate]=useState("");
      const [expandedNotice,setExpandedNotice]=useState("");
      const [debugUrl,setDebugUrl]=useState("");

      // Filtros locales
      const [tempMinRating,setTempMinRating]=useState("");
      const [tempMinReviews,setTempMinReviews]=useState("");
      const [minRating,setMinRating]=useState("");
      const [minReviews,setMinReviews]=useState("");

      // Orden
      const [sortOpen, setSortOpen] = useState(false);
      const [sortKey, setSortKey] = useState("rating"); // rating | reviews | price
      const sortBtnRef = useRef(null);

      // Overlay PDF
      const [pdfOverlay, setPdfOverlay] = useState(false);

      const t = (k)=> (TEXTS[lang] && TEXTS[lang][k]) ? TEXTS[lang][k] : (TEXTS["es"][k] || k);
      const formatMiles=(n)=> (n??0).toLocaleString(lang==="es"?"es-MX":lang==="pt"?"pt-BR":lang==="fr"?"fr-FR":lang==="ja"?"ja-JP":"en-US");

      useEffect(()=>{ const saved=localStorage.getItem("aaron_dark")==="1"; setDark(saved); document.documentElement.classList.toggle("dark",saved); },[]);
      useEffect(()=>{ localStorage.setItem("aaron_dark",dark?"1":"0"); document.documentElement.classList.toggle("dark",dark); },[dark]);
      useEffect(()=>{ document.title=t("title"); localStorage.setItem("aaron_lang", lang); },[lang]);

      // Cierre del popover al hacer click fuera
      useEffect(()=>{
        function onDocClick(e){
          if (sortBtnRef.current && !sortBtnRef.current.contains(e.target)) setSortOpen(false);
        }
        document.addEventListener("click", onDocClick);
        return ()=> document.removeEventListener("click", onDocClick);
      },[]);

      const showToastMsg = (text, isWarn=false) => { setToast({ text, warn: isWarn, ts: Date.now() }); setTimeout(()=> setToast(""), 2200); };

      // Helper de espera (para next_page_token)
      const wait = (ms)=> new Promise(res=> setTimeout(res, ms));

      /* ======= BÃºsqueda con paginaciÃ³n automÃ¡tica (hasta 3 pÃ¡ginas) ======= */
      async function fetchPlaces(q) {
        if(!q.trim() && !placeType){
          showToastMsg(lang==="en"?"âš ï¸ Type a query or select a place type.":"âš ï¸ Escribe una consulta o selecciona un tipo de lugar.", true);
          return;
        }
        setLoading(true);
        setMessage(t("updating"));

        try {
          const rawText = (q||"");
          const baseText = rawText.trim();
          const noText = baseText.length===0;

          let queriesToRun = [];
          let showExpanded = false;

          if (noText && placeType) {
            const keyword = TYPE_TO_KEYWORD[placeType] || "";
            const textQuery = keyword ? `${keyword} en ${city}` : city;
            queriesToRun = [textQuery];
          } else if (isLikelyProperName(rawText)) {
            const textQuery = `${rawText} en ${city}`;
            queriesToRun = [textQuery];
          } else {
            const terms = expandQueryTerms(baseText || ((lang==="es"||lang==="pt")?"restaurantes":"restaurants"));
            const visible = terms.filter(Boolean).slice(0, 12);
            showExpanded = visible.length > 1;
            queriesToRun = visible.length ? visible.map(t => {
              const term = t;
              const inFood = GENERIC_FOOD.some(w => t.includes(normalize(w)));
              const inLeisure = GENERIC_LEISURE.some(w => t.includes(normalize(w)));
              const genericByPattern = looksGeneric(t);
              if ((inFood || genericByPattern) && !inLeisure) return `restaurantes de ${term} en ${city}`;
              if (inLeisure && !inFood) return `lugares de ${term} en ${city}`;
              return `${term} en ${city}`;
            }) : [`${baseText} en ${city}`];
          }

          if (showExpanded) {
            setExpandedNotice(`${t("expanded_prefix")} ${queriesToRun.map(x=>x.split(" en ")[0]).slice(0,8).join(", ")}`);
            setTimeout(() => setExpandedNotice(""), 3000);
          } else {
            setExpandedNotice("");
          }

          const seen = new Map();
          const TOTAL_PAGES = 3;

          for (const textQuery of queriesToRun) {
            let page = 1;
            let pageToken = "";
            while (page <= TOTAL_PAGES) {
              const url = API_BASE + "?q=" + encodeURIComponent(textQuery)
                           + (placeType ? "&type="+encodeURIComponent(placeType) : "")
                           + (pageToken ? "&pageToken="+encodeURIComponent(pageToken) : "");
              console.log("ğŸ” URL generada:", url);
              setDebugUrl(url);
              if (page > 1) setMessage(t("loading_more").replace("{cur}", String(page)).replace("{tot}", String(TOTAL_PAGES)));

              const res = await fetch(url);
              const json = await res.json();

              const arr = (json.results || []).map((p, i) => ({
                id: p.place_id || `${textQuery}_${page}_${i}`,
                nombre: p.name || "-",
                calificacion: p.rating ?? "-",
                reseÃ±as: p.user_ratings_total ?? 0,
                precio: p.price_level ?? null,
                direccion: p.formatted_address || p.vicinity || "-",
                lugarId: p.place_id || null,
                telefono: p.formatted_phone_number || null,
                horario: (p.opening_hours && p.opening_hours.weekday_text)
                  ? p.opening_hours.weekday_text.join(" Â· ")
                  : (p.opening_hours && typeof p.opening_hours.open_now==="boolean")
                      ? (p.opening_hours.open_now ? (lang==="en"?"Open now":"Abierto ahora") : (lang==="en"?"Closed":"Cerrado"))
                      : null,
                url: p.url || null,
                tipos: p.types || [],
                icono: p.icon || null
              }));

              for (const place of arr) {
                const key = (normalize(place.nombre || "-")) + "|" + (normalize(place.direccion || "-"));
                if (!seen.has(key)) {
                  seen.set(key, place);
                } else {
                  const prev = seen.get(key);
                  if ((Number(place.calificacion)||0) > (Number(prev.calificacion)||0)) prev.calificacion = place.calificacion;
                  if ((place.reseÃ±as||0) > (prev.reseÃ±as||0)) prev.reseÃ±as = place.reseÃ±as;
                  if (prev.precio == null && place.precio != null) prev.precio = place.precio;
                  if (!prev.icono && place.icono) prev.icono = place.icono;
                  seen.set(key, prev);
                }
              }

              pageToken = json.next_page_token || json.nextPageToken || "";
              if (!pageToken) break;
              page++;
              await wait(2000); // Requerido por Google antes de reutilizar el token
            }
          }

          // Orden inicial por calificaciÃ³n desc
          const data = Array.from(seen.values()).sort(
            (a, b) => (Number(b.calificacion) || 0) - (Number(a.calificacion) || 0)
          );
          setRows(data);
          setMessage(t("dataUpdated"));

          const now = new Date();
          setLastUpdate(now.toLocaleDateString("es-MX") + " " + now.toLocaleTimeString("es-MX",{ hour: '2-digit', minute: '2-digit' }));
        } catch (e) {
          console.error(e);
          setMessage("âŒ " + (lang==="en"?"API error":"Error al consultar la API"));
          showToastMsg("âŒ " + (lang==="en"?"API error":"Error al consultar la API"), true);
        } finally {
          setLoading(false);
          setTimeout(()=> setDebugUrl(""), 5000);
        }
      }

      /* ======= Filtros (se aplican a rows) + Orden dinÃ¡mico ======= */
      const sortedFiltered = useMemo(()=>{
        // Filtro local
        let arr = rows.filter(r=>{
          const passRating = minRating ? (Number(r.calificacion)>=Number(minRating)) : true;
          const passReviews = minReviews ? (Number(r.reseÃ±as) >= Number(minReviews)) : true;
          return passRating && passReviews;
        });

        // Orden
        if (sortKey === "rating") {
          arr = arr.sort((a,b)=>(Number(b.calificacion)||0)-(Number(a.calificacion)||0));
        } else if (sortKey === "reviews") {
          arr = arr.sort((a,b)=>(Number(b.reseÃ±as)||0)-(Number(a.reseÃ±as)||0));
        } else if (sortKey === "price") {
          arr = arr.sort((a,b)=>(Number(a.precio)||99)-(Number(b.precio)||99));
        }
        return arr;
      },[rows, minRating, minReviews, sortKey]);

      // ğŸ§¾ PDF (multi-pÃ¡gina, encabezado repetido, pie traducido)
      const exportPDF = async () => {
        setPdfOverlay(true);
        const darkMode = document.documentElement.classList.contains("dark");

        const wrapper = document.createElement("div");
        wrapper.style.padding = "10px";
        wrapper.style.fontFamily = "Arial, 'Noto Sans JP', sans-serif";
        wrapper.style.color = darkMode ? "#fff" : "#000";
        wrapper.style.backgroundColor = darkMode ? "#000" : "#fff";

        const header = document.createElement("div");
        header.style.display = "flex"; header.style.flexDirection = "column";
        header.style.alignItems = "center"; header.style.gap = "8px"; header.style.marginBottom = "10px";

        const img = document.createElement("img"); img.src = buildPdfLogoDataURL(); img.style.height = "46px"; img.style.width = "auto";
        const filters = document.createElement("div");
        filters.style.fontSize = "12px"; filters.style.opacity = "0.85";
        const r = minRating ? `${minRating}+`:"â€”";
        const rv = minReviews ? `${Number(minReviews).toLocaleString("es-MX")}+`:"â€”";
        const typeSel = placeType ? (TYPE_TO_KEYWORD[placeType] || placeType) : (TEXTS[lang].all || "All");
        filters.textContent = `${t("pdf_city")}: ${city}  |  ${t("pdf_rating")}: ${r}  |  ${t("pdf_reviews")}: ${rv}  |  ${t("pdf_type")}: ${typeSel}`;
        header.appendChild(img); header.appendChild(filters);

        // Tabla grande
        const table = document.createElement("table");
        table.style.width = "100%"; table.style.borderCollapse = "collapse"; table.style.fontSize = "12px";

        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        const ths = ["#", t("menu_home").replace("ğŸ  ",""), t("pdf_rating"), "Precio", t("pdf_reviews"), "DirecciÃ³n", t("pdf_open")];
        ths.forEach(txt => {
          const th = document.createElement("th");
          th.textContent = txt;
          th.style.border = "1px solid " + (darkMode ? "#333" : "#ccc");
          th.style.backgroundColor = darkMode ? "#1a1a1a" : "#eef2ff";
          th.style.color = darkMode ? "#fff" : "#111";
          th.style.padding = "6px";
          th.style.position = "sticky";
          thead.appendChild(th);
        });
        trh.appendChild(thead);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        sortedFiltered.forEach((r, idx) => {
          const tr = document.createElement("tr");
          const cells = [
            String(idx+1),
            r.nombre || "â€”",
            (r.calificacion ?? "â€”"),
            ( (n => n===1?"$":n===2?"$$":n===3?"$$$":n===4?"$$$$":"â€”")(Number(r.precio)) ),
            ( (r.reseÃ±as??0).toLocaleString("es-MX") ),
            r.direccion || "â€”",
            t("pdf_open")
          ];
          cells.forEach((val, i) => {
            const td = document.createElement("td");
            td.textContent = val;
            td.style.border = "1px solid " + (darkMode ? "#333" : "#ddd");
            td.style.padding = "6px";
            if(i===2 || i===3 || i===4 || i===6) td.style.textAlign = "center";
            if(i===6){
              td.textContent = "";
              const a = document.createElement("a");
              a.href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent((r.nombre||"")+" "+(r.direccion||""));
              a.textContent = t("pdf_open");
              a.style.color = "#2563eb";
              td.appendChild(a);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // Envoltura final con header + table + footer
        const container = document.createElement("div");
        container.appendChild(header);
        container.appendChild(table);

        const footer = document.createElement("div");
        footer.style.fontSize = "10px"; footer.style.opacity = "0.8";
        footer.style.textAlign = "right"; footer.style.marginTop = "8px";
        footer.textContent = t("pdf_generated");
        container.appendChild(footer);

        document.body.appendChild(container);

        const now = new Date();
        const fecha = now.toLocaleDateString("es-MX");
        const hora = now.toLocaleTimeString("es-MX",{hour:'2-digit',minute:'2-digit'});
        const filename = `reporte_${fecha}_${hora.replace(':','-')}.pdf`;

        try {
          await html2pdf().set({
            margin: 10,
            filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3, useCORS: true, allowTaint: true, backgroundColor: darkMode ? "#000000" : "#ffffff", windowWidth: container.scrollWidth },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css','legacy','avoid-all'] }
          }).from(wrapperize(container)).save(); // wrapperize garantiza cortes limpios
        } finally {
          document.body.removeChild(container);
          setPdfOverlay(false);
        }
      };

      // Crea un wrapper para asegurar que el contenido se calcule completo
      function wrapperize(node){
        const w = document.createElement("div");
        w.style.padding = "10px";
        w.style.background = getComputedStyle(document.documentElement).getPropertyValue("--pdf-bg") || "#fff";
        w.appendChild(node);
        return w;
      }

      const applyFilters = ()=>{ setMinRating(tempMinRating); setMinReviews(tempMinReviews); setMessage(t("filtersApplied")); setTimeout(()=>setMessage(""), 2500); };
      const clearAll = ()=>{ setQuery(""); setPlaceType(""); setRows([]); setTempMinRating(""); setTempMinReviews(""); setMinRating(""); setMinReviews(""); setMessage(""); setExpandedNotice(""); setLastUpdate(""); showToastMsg(lang==="en"?"Cleared":"Limpieza completa âœ”ï¸"); };
      const resetHome=()=>{ setOpenMenu(false); clearAll(); setCity("Ciudad de MÃ©xico"); window.scrollTo({ top: 0, behavior: "smooth" }); };

      const [langKey, setLangKey] = useState(0);
      useEffect(()=>{ setLangKey(x => x + 1); }, [lang]);

      const LangItem = ({code, flag, name}) => (
        <div className={`lang-item ${lang===code ? "active" : ""}`} onClick={()=>setLang(code)} aria-label={name}>
          <span className="lang-flag">{flag}</span><span className="lang-name">{name}</span>
        </div>
      );

      // Cambia orden con menÃº de icono
      const setOrder = (key)=>{
        setSortKey(key);
        if (key==="rating") showToastMsg(t("sorted_by_rating"));
        if (key==="reviews") showToastMsg(t("sorted_by_reviews"));
        if (key==="price") showToastMsg(t("sorted_by_price"));
        setSortOpen(false);
      };

      return (
        <div className="min-h-screen" key={langKey}>
          {/* Header */}
          <header className="bg-blue-600 text-white px-4 py-3 shadow-md flex items-center gap-3">
            <button onClick={()=>setOpenMenu(true)} className="text-2xl hover:opacity-80" aria-label="Abrir menÃº">â˜°</button>
            <img src={HEADER_LOGO_SRC} alt="Logo" className="h-12 w-auto" />
            <h1 className="text-xl font-bold">{t("title")}</h1>
            <div className="ml-auto">
              <button onClick={()=>setDark(!dark)} className="text-white text-xl" title={t("access_theme")}>ğŸŒ“</button>
            </div>
          </header>

          {/* Backdrop MenÃº */}
          {openMenu && <div className="fixed inset-0 bg-black/40 z-40" onClick={()=>setOpenMenu(false)}></div>}

          {/* MenÃº lateral */}
          <aside className={"fixed top-0 left-0 z-50 bg-white w-64 h-full shadow-xl menu-panel "+(openMenu?"open":"")}>
            <div className="p-4 border-b flex items-center justify-between">
              <span className="font-semibold">{t("menu_title")}</span>
              <button onClick={()=>setOpenMenu(false)} className="text-lg" aria-label="Cerrar">âœ•</button>
            </div>
            <nav className="p-4 space-y-3 text-gray-700">
              <div className="hover:underline cursor-pointer" onClick={resetHome}>{t("menu_home")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenReports(true); setOpenMenu(false);}}>{t("menu_reports")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenHelp(true); setOpenMenu(false);}}>{t("menu_help")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenAccess(true); setOpenMenu(false);}}>{t("menu_access")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenAbout(true); setOpenMenu(false);}}>{t("menu_about")}</div>
            </nav>
          </aside>

          {/* ğŸ”µ BLOQUE A â€” BÃšSQUEDA */}
          <section className="max-w-6xl mx-auto mt-6 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-4">
              <h2 className="text-lg font-semibold text-blue-700">ğŸ” {t("searchBtn")}</h2>
              <div className="flex flex-col md:flex-row gap-3 items-start md:items-end">
                <div className="w-full md:w-1/4">
                  <label className="block text-sm text-gray-600 mb-1">{t("city")}</label>
                  <select value={city} onChange={(e)=>setCity(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option>Ciudad de MÃ©xico</option>
                    <option>Guadalajara</option>
                    <option>Monterrey</option>
                  </select>
                </div>

                <div className="flex-1 w-full">
                  <label className="block text-sm text-gray-600 mb-1">{t("query")}</label>
                  <input
                    type="text" value={query} onChange={(e)=>setQuery(e.target.value)}
                    onKeyDown={(e)=>{ if(e.key==="Enter") fetchPlaces(query); }}
                    placeholder="Ej. 'Casa de ToÃ±o', 'taquerÃ­as', 'museos', 'pizza'â€¦"
                    className="border rounded-lg p-2 w-full shadow-sm"
                  />
                </div>

                <div className="w-full md:w-64">
                  <label className="block text-sm text-gray-600 mb-1">{t("type")}</label>
                  <select value={placeType} onChange={(e)=>setPlaceType(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{t("all")}</option>
                    <option value="restaurant">ğŸ½ï¸ Restaurante</option>
                    <option value="cafe">â˜• CafeterÃ­a</option>
                    <option value="bar">ğŸº Bar / Cantina</option>
                    <option value="night_club">ğŸ¸ Antro / Club</option>
                    <option value="bakery">ğŸ¥ PanaderÃ­a</option>
                    <option value="meal_takeaway">ğŸ± Comida para llevar</option>
                    <option value="meal_delivery">ğŸ• Comida a domicilio</option>
                    <option value="museum">ğŸ›ï¸ Museo</option>
                    <option value="art_gallery">ğŸ¨ GalerÃ­a de arte</option>
                    <option value="tourist_attraction">ğŸï¸ AtracciÃ³n turÃ­stica</option>
                    <option value="lodging">ğŸ¨ Hotel / Hospedaje</option>
                    <option value="shopping_mall">ğŸ›ï¸ Centro comercial</option>
                    <option value="gym">ğŸ’ª Gimnasio</option>
                    <option value="beauty_salon">ğŸ’‡â€â™€ï¸ SalÃ³n de belleza</option>
                    <option value="movie_theater">ğŸ­ Cine / Teatro</option>
                  </select>

                  <button className="text-blue-600 underline mt-2" onClick={()=>setShowMoreTypes(!showMoreTypes)}>{t("moreTypes")}</button>
                  {showMoreTypes && (
                    <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("park")}>ğŸï¸ Parque</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("store")}>ğŸª Tienda</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("gas_station")}>â›½ Gasolinera</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("pharmacy")}>ğŸ’Š Farmacia</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("hospital")}>ğŸ¥ Hospital</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("church")}>â›ª Iglesia</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("bank")}>ğŸ¦ Banco</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("atm")}>ğŸ§ Cajero</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("car_repair")}>ğŸ”§ Taller mecÃ¡nico</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("car_rental")}>ğŸš™ Renta de autos</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("airport")}>âœˆï¸ Aeropuerto</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("bus_station")}>ğŸšŒ Terminal</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("train_station")}>ğŸš† EstaciÃ³n</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("electronics_store")}>ğŸ’» ElectrÃ³nica</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("supermarket")}>ğŸ›’ Supermercado</button>
                    </div>
                  )}
                </div>

                <div className="flex items-center gap-3">
                  <button onClick={()=>fetchPlaces(query)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">{t("searchBtn")}</button>
                  {loading && <div className="spinner" aria-label="Cargando"></div>}
                </div>
              </div>
            </div>
          </section>

          {/* ğŸŸ¤ Filtros */}
          <section className="max-w-6xl mx-auto mt-4 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-3">
              <h2 className="text-lg font-semibold text-gray-700">ğŸ§© {t("applyFilters").split(" ")[0]} (sobre resultados actuales)</h2>
              <div className="flex flex-col md:flex-row gap-3 items-end">
                <div className="w-full md:w-56">
                  <label className="block text-sm text-gray-600 mb-1">{t("minRating")}</label>
                  <select value={tempMinRating} onChange={(e)=>setTempMinRating(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{t("all")}</option>
                    <option value="4.0">4.0+</option>
                    <option value="4.2">4.2+</option>
                    <option value="4.4">4.4+</option>
                    <option value="4.6">4.6+</option>
                    <option value="4.8">4.8+</option>
                  </select>
                </div>
                <div className="w-full md:w-56">
                  <label className="block text-sm text-gray-600 mb-1">{t("minReviews")}</label>
                  <select value={tempMinReviews} onChange={(e)=>setTempMinReviews(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{t("all")}</option>
                    <option value="1000">1,000+</option>
                    <option value="5000">5,000+</option>
                    <option value="10000">10,000+</option>
                    <option value="15000">15,000+</option>
                    <option value="20000">20,000+</option>
                    <option value="25000">25,000+</option>
                    <option value="30000">30,000+</option>
                  </select>
                </div>
                <div className="flex gap-2">
                  <button onClick={applyFilters} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">{t("applyFilters")}</button>
                  <button onClick={clearAll} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">{t("clearFilters")}</button>
                </div>
              </div>
            </div>
          </section>

          {/* Mensajes arriba de la tabla */}
          <section className="max-w-6xl mx-auto px-4 mt-3">
            {!loading && message && <div className="text-green-700 bg-green-50 border border-green-200 rounded p-2 text-sm">{message}</div>}
            {debugUrl && (
              <div className="text-xs mt-2 text-gray-600 bg-gray-100 border rounded p-2 overflow-x-auto">
                <strong>ğŸ” URL:</strong> {debugUrl}
              </div>
            )}
          </section>

          {/* Resultados */}
          <section id="results-section" className="max-w-6xl mx-auto mt-3 px-4">
            <div className="bg-white rounded-xl shadow overflow-hidden">
              <div className="bg-blue-600 text-white px-4 py-3 font-semibold flex justify-between items-center">
                <span>{t("results")}</span>
                <button onClick={exportPDF} className="bg-white text-blue-700 font-semibold px-3 py-1 rounded hover:bg-blue-50 text-sm">{t("exportPDF")}</button>
              </div>

              {expandedNotice && (
                <div className="px-4 py-2 bg-blue-100 text-blue-800 border-t border-b border-blue-200 text-sm">
                  {expandedNotice}
                </div>
              )}

              {/* Controles antes de la tabla: contador + botÃ³n de orden (icono) */}
              <div className="flex items-center justify-between px-4 pt-3">
                <div className="text-sm text-gray-600">
                  ğŸ“Š {sortedFiltered.length.toLocaleString("es-MX")} {t("results_count")}
                </div>
                <div className="relative" ref={sortBtnRef}>
                  <button
                    title={t("sort_tooltip")}
                    onClick={()=>setSortOpen(o=>!o)}
                    className="px-2 py-1 border rounded hover:bg-gray-50 text-gray-700"
                    aria-label={t("sort_tooltip")}
                  >
                    ğŸ”½
                  </button>
                  {sortOpen && (
                    <div className="sort-pop w-56">
                      <button onClick={()=>setOrder("rating")}><span>â­</span><span>{t("sort_rating")}</span></button>
                      <button onClick={()=>setOrder("reviews")}><span>ğŸ’¬</span><span>{t("sort_reviews")}</span></button>
                      <button onClick={()=>setOrder("price")}><span>ğŸ’²</span><span>{t("sort_price")}</span></button>
                    </div>
                  )}
                </div>
              </div>

              <div className="p-4 overflow-x-auto">
                <table className="min-w-full text-sm border">
                  <thead className="bg-blue-100">
                    <tr>
                      <th className="border p-2 text-center">#</th>
                      <th className="border p-2 text-left">ğŸ  {t("menu_home").replace("ğŸ  ","")}</th>
                      <th className="border p-2 text-center">â­ {t("info_rating")}</th>
                      <th className="border p-2 text-center">ğŸ’² {t("info_price")}</th>
                      <th className="border p-2 text-center">ğŸ’¬ {t("info_reviews")}</th>
                      <th className="border p-2 text-left">ğŸ“ {t("info_address")}</th>
                      <th className="border p-2 text-center">ğŸ”— {t("info_map")}</th>
                      <th className="border p-2 text-center">â„¹ï¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedFiltered.map((r, idx)=>(
                      <tr key={idx} className="hover:bg-blue-50 transition-all">
                        <td className="border p-2 text-center">{idx+1}</td>
                        <td className="border p-2">
                          <div className="flex items-center gap-2">
                            <img src={r.icono || PLACEHOLDER_IMG} alt="" className="w-6 h-6 rounded-sm object-contain bg-white border" />
                            <span className="font-medium">{r.nombre}</span>
                          </div>
                        </td>
                        <td className="border p-2 text-center">{r.calificacion}</td>
                        <td className="border p-2 text-center">{priceToSymbol(r.precio)}</td>
                        <td className="border p-2 text-center">{formatMiles(r.reseÃ±as)}</td>
                        <td className="border p-2">{r.direccion}</td>
                        <td className="border p-2 text-center">
                          <a href={"https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent((r.nombre||"")+" "+(r.direccion||""))}
                             target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                            {t("pdf_open")}
                          </a>
                        </td>
                        <td className="border p-2 text-center">
                          <button className="underline text-blue-600 hover:opacity-80" onClick={()=>setInfoRow(r)}>â„¹ï¸</button>
                        </td>
                      </tr>
                    ))}
                    {sortedFiltered.length===0 && (
                      <tr>
                        <td colSpan="8" className="text-center text-gray-500 p-6">{t("noResults")}</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="flex flex-col items-center justify-center mt-6 mb-10">
              {lastUpdate && (
                <p className="text-gray-500 text-sm mt-1">{t("lastUpdate")}: {lastUpdate}</p>
              )}
            </div>
          </section>

          {/* Modales: Ayuda / Acerca / Reportes / Accesibilidad / Info */}
          {openHelp && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("help_title")}</h2>
                <p className="text-sm text-gray-700 mb-4">{t("help_text")}</p>
                <button onClick={()=>setOpenHelp(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openAbout && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("about_title")}</h2>
                <p className="text-gray-700 mb-4">{t("about_line1")}<br/>{t("about_line2")}</p>
                <button onClick={()=>setOpenAbout(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openReports && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("reports_title")}</h2>
                <p className="text-gray-700 mb-1">{t("reports_line1")}</p>
                <p className="text-gray-700 mb-4">{t("reports_line2")}</p>
                <button onClick={()=>setOpenReports(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openAccess && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-2 text-blue-600">{t("access_title")}</h2>
                <p className="text-sm text-gray-700 mb-4">{t("access_select")}</p>

                <div className="space-y-2 mb-6 text-left">
                  <LangItem code="es" flag="ğŸ‡²ğŸ‡½" name={t("access_es")} />
                  <LangItem code="en" flag="ğŸ‡¬ğŸ‡§" name={t("access_en")} />
                  <LangItem code="fr" flag="ğŸ‡«ğŸ‡·" name={t("access_fr")} />
                  <LangItem code="pt" flag="ğŸ‡µğŸ‡¹" name={t("access_pt")} />
                  <LangItem code="ja" flag="ğŸ‡¯ğŸ‡µ" name={t("access_ja")} />
                </div>

                <div className="flex items-center justify-center gap-3 mb-6">
                  <input id="darkmode" type="checkbox" checked={dark} onChange={()=>setDark(!dark)} />
                  <label htmlFor="darkmode">{t("access_theme")}</label>
                </div>

                <button onClick={()=>setOpenAccess(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {infoRow && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
                <h3 className="text-lg font-semibold text-blue-600 mb-2">{t("info_title")}</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                  <div><b>ğŸ  {t("menu_home").replace("ğŸ  ","Nombre")}:</b> {infoRow.nombre}</div>
                  <div><b>â­ {t("info_rating")}:</b> {infoRow.calificacion || "â€”"}</div>
                  <div className="sm:col-span-2"><b>ğŸ“ {t("info_address")}:</b> {infoRow.direccion || "â€”"}</div>
                  <div><b>ğŸ’² {t("info_price")}:</b> {priceToSymbol(infoRow.precio)}</div>
                  <div><b>ğŸ“ {t("info_phone")}:</b> {infoRow.telefono || "â€”"}</div>
                  <div className="sm:col-span-2"><b>â° {t("info_hours")}:</b> {infoRow.horario || "â€”"}</div>
                  <div className="sm:col-span-2">
                    <a className="text-blue-600 underline"
                      href={"https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent((infoRow.nombre||"")+" "+(infoRow.direccion||""))}
                      target="_blank" rel="noopener noreferrer">ğŸ”— {t("info_map")}
                    </a>
                  </div>
                </div>
                <div className="mt-4 text-right">
                  <button onClick={()=>setInfoRow(null)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
                </div>
              </div>
            </div>
          )}

          {/* Toast centrado */}
          {toast && toast.text && (<div className={"toast "+(toast.warn?"warn":"")}>{toast.text}</div>)}

          {/* Overlay de Generando PDF */}
          {pdfOverlay && (
            <div className="overlay">
              <div className="overlay-box">
                <div className="spinner" aria-hidden="true"></div>
                <div>{t("pdf_generating")}</div>
              </div>
            </div>
          )}

          {/* Footer */}
          <footer className="mt-10 p-4 text-center text-gray-500 text-sm flex flex-col md:flex-row justify-between items-center border-t border-gray-200">
            <span>Â© 2025 {t("title")} â€” {lang==="ja" ? "ã™ã¹ã¦ã®æ¨©åˆ©ã‚’ä¿æœ‰ã—ã¾ã™ã€‚" : "Todos los derechos reservados."}</span>
            <span className="text-right font-semibold text-gray-600">{t("footer_version")}</span>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>