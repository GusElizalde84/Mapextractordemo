<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendaciones de AarÃ³n</title>

  <!-- Tailwind (dark mode por clase) -->
  <script>tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel + html2pdf -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto', sans-serif; }
    .spinner { border: 4px solid #e0e0e0; border-top: 4px solid #1e88e5; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    .menu-panel { transform: translateX(-100%); transition: transform .3s ease; }
    .menu-panel.open { transform: translateX(0); }

    /* ğŸŒ™ Modo oscuro con contraste alto */
    .dark { background-color: #000 !important; color: #fff !important; }
    .dark .bg-white { background-color: #111 !important; }
    .dark input, .dark select, .dark textarea { background-color: #222 !important; color: #fff !important; border-color: #444 !important; }
    .dark input::placeholder { color: #bbb !important; }
    .dark table { background-color: #000 !important; }
    .dark table th { background-color: #1a1a1a !important; color: #fff !important; border-color: #333 !important; }
    .dark table td { background-color: #0d0d0d !important; color: #f2f2f2 !important; border-color: #333 !important; }
    .dark .bg-blue-600 { background-color: #0057d9 !important; color: #fff !important; }
    .dark .hover\:bg-blue-700:hover { background-color: #0042a3 !important; }
    .dark .text-blue-600 { color: #5ea0ff !important; }
    .dark .bg-blue-100 { background-color: #1a1a1a !important; }
    .dark .border { border-color: #333 !important; }
    .dark .shadow { box-shadow: 0 0 10px rgba= (255,255,255,0.08) !important; }
    .dark .hover\:bg-blue-50:hover { background-color: #222 !important; }
    .dark button { color: #fff !important; border-color: #333 !important; }
    .dark .bg-white.text-blue-700 { background-color: #333 !important; color: #fff !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const API_BASE = "https://aaronbestplaces.vercel.app/api/lugares";

    /* ======= Textos ======= */
    const textos = {
      es: { title:"Recomendaciones de AarÃ³n", menu_home:"ğŸ  Inicio", menu_reports:"ğŸ“Š Reportes", menu_help:"â“ Ayuda", menu_access:"ğŸŒ Accesibilidad", menu_about:"â„¹ï¸ Acerca de",
            city:"Ciudad", query:"Consulta", type:"Tipo de lugar", moreTypes:"MÃ¡s categorÃ­asâ€¦", searchBtn:"Buscar lugares",
            minRating:"CalificaciÃ³n mÃ­nima â­", minReviews:"ReseÃ±as mÃ­nimas ğŸ’¬", all:"Todas", applyFilters:"Aplicar filtros", clearFilters:"ğŸ§¹ Limpiar filtros",
            results:"RESULTADOS", exportPDF:"ğŸ“„ Exportar a PDF",
            updating:"ğŸ” Consultando nuevos lugares en Google Mapsâ€¦", filtersApplied:"âœ… Filtros aplicados sobre los resultados actuales.",
            dataUpdated:"âœ… Datos actualizados correctamente", lastUpdate:"Ãšltima actualizaciÃ³n",
            noResults:"Sin resultados. Usa el buscador para traer datos de Google Maps.", updateData:"Actualizar datos",
            help_title:"Ayuda",
            help_text:"1) En â€˜Buscar lugaresâ€™, escribe el nombre o palabra (opcional elige â€˜Tipo de lugarâ€™) y la ciudad; presiona â€˜Buscar lugaresâ€™. 2) En â€˜Filtrosâ€™, ajusta calificaciÃ³n y reseÃ±as y presiona â€˜Aplicar filtrosâ€™. 3) Exporta a PDF en el encabezado de resultados.",
            close:"Cerrar", about_title:"Acerca de", about_line1:"Una aplicaciÃ³n para los mejores guÃ­as Edith y AarÃ³n", about_line2:"De sus amigos Lili y Gus",
            access_title:"Accesibilidad", access_select:"Selecciona el idioma", access_es:"EspaÃ±ol", access_en:"English", access_fr:"FranÃ§ais", access_pt:"PortuguÃªs",
            access_theme:"Modo oscuro", reports_title:"Reportes", reports_line1:"PrÃ³ximamente habrÃ¡ novedades en esta secciÃ³n.", reports_line2:"Â¡Estamos trabajando para ofrecerte reportes y estadÃ­sticas personalizadas!",
            info_title:"Detalles del lugar", info_rating:"CalificaciÃ³n", info_reviews:"ReseÃ±as", info_price:"Precio", info_address:"DirecciÃ³n", info_phone:"TelÃ©fono", info_hours:"Horario", info_map:"Abrir en Google Maps",
            footer_version:"VersiÃ³n 50.1", expanded_prefix:"ğŸ” BÃºsqueda ampliada:" },
      en: { title:"Aaronâ€™s Recommendations", menu_home:"ğŸ  Home", menu_reports:"ğŸ“Š Reports", menu_help:"â“ Help", menu_access:"ğŸŒ Accessibility", menu_about:"â„¹ï¸ About",
            city:"City", query:"Query", type:"Place type", moreTypes:"More categoriesâ€¦", searchBtn:"Search places",
            minRating:"Minimum rating â­", minReviews:"Min. reviews ğŸ’¬", all:"All", applyFilters:"Apply filters", clearFilters:"ğŸ§¹ Clear filters",
            results:"RESULTS", exportPDF:"ğŸ“„ Export to PDF",
            updating:"ğŸ” Fetching new places from Google Mapsâ€¦", filtersApplied:"âœ… Filters applied to current results.",
            dataUpdated:"âœ… Data updated successfully", lastUpdate:"Last updated",
            noResults:"No results. Use the search to fetch data from Google Maps.", updateData:"Refresh data",
            help_title:"Help",
            help_text:"1) In â€˜Search placesâ€™, type a keyword (optionally choose â€˜Place typeâ€™) and the city; click â€˜Search placesâ€™. 2) In â€˜Filtersâ€™, set rating and reviews then â€˜Apply filtersâ€™. 3) Export PDF in results header.",
            close:"Close", about_title:"About", about_line1:"An app for the best guides Edith and AarÃ³n", about_line2:"From their friends Lili and Gus",
            access_title:"Accessibility", access_select:"Select language", access_es:"Spanish", access_en:"English", access_fr:"French", access_pt:"Portuguese", access_theme:"Dark mode",
            reports_title:"Reports", reports_line1:"New features are coming soon.", reports_line2:"Weâ€™re working on personalized reports and stats!",
            info_title:"Place details", info_rating:"Rating", info_reviews:"Reviews", info_price:"Price", info_address:"Address", info_phone:"Phone", info_hours:"Hours", info_map:"Open in Google Maps",
            footer_version:"Version 50.1", expanded_prefix:"ğŸ” Expanded search:" },
      fr: { title:"Recommandations dâ€™AarÃ³n", menu_home:"ğŸ  Accueil", menu_reports:"ğŸ“Š Rapports", menu_help:"â“ Aide", menu_access:"ğŸŒ AccessibilitÃ©", menu_about:"â„¹ï¸ Ã€ propos",
            city:"Ville", query:"Recherche", type:"Type de lieu", moreTypes:"Plus de catÃ©goriesâ€¦", searchBtn:"Rechercher des lieux",
            minRating:"Note minimale â­", minReviews:"Avis min. ğŸ’¬", all:"Toutes", applyFilters:"Appliquer les filtres", clearFilters:"ğŸ§¹ Effacer",
            results:"RÃ‰SULTATS", exportPDF:"ğŸ“„ Exporter en PDF",
            updating:"ğŸ” Recherche de nouveaux lieux sur Google Mapsâ€¦", filtersApplied:"âœ… Filtres appliquÃ©s aux rÃ©sultats actuels.",
            dataUpdated:"âœ… DonnÃ©es mises Ã  jour", lastUpdate:"DerniÃ¨re mise Ã  jour",
            noResults:"Aucun rÃ©sultat. Lancez une recherche.", updateData:"Actualiser",
            help_title:"Aide",
            help_text:"1) Dans â€˜Rechercher des lieuxâ€™, saisissez un mot (option: â€˜Type de lieuâ€™) et la ville; cliquez â€˜Rechercherâ€™. 2) Dans â€˜Filtresâ€™, rÃ©glez note et avis et â€˜Appliquerâ€™. 3) Exportez en PDF dans lâ€™en-tÃªte des rÃ©sultats.",
            close:"Fermer", about_title:"Ã€ propos", about_line1:"Une application pour les meilleurs guides Edith et AarÃ³n", about_line2:"De la part de leurs amis Lili et Gus",
            access_title:"AccessibilitÃ©", access_select:"SÃ©lectionnez la langue", access_es:"Espagnol", access_en:"Anglais", access_fr:"FranÃ§ais", access_pt:"Portugais", access_theme:"Mode sombre",
            reports_title:"Rapports", reports_line1:"Des nouveautÃ©s arrivent bientÃ´t.", reports_line2:"Nous travaillons sur des rapports personnalisÃ©s !",
            info_title:"DÃ©tails du lieu", info_rating:"Note", info_reviews:"Avis", info_price:"Prix", info_address:"Adresse", info_phone:"TÃ©lÃ©phone", info_hours:"Horaires", info_map:"Ouvrir dans Google Maps",
            footer_version:"Version 50.1", expanded_prefix:"ğŸ” Recherche Ã©tendue :" },
      pt: { title:"RecomendaÃ§Ãµes do AarÃ³n", menu_home:"ğŸ  InÃ­cio", menu_reports:"ğŸ“Š RelatÃ³rios", menu_help:"â“ Ajuda", menu_access:"ğŸŒ Acessibilidade", menu_about:"â„¹ï¸ Sobre",
            city:"Cidade", query:"Consulta", type:"Tipo de lugar", moreTypes:"Mais categoriasâ€¦", searchBtn:"Buscar lugares",
            minRating:"ClassificaÃ§Ã£o mÃ­nima â­", minReviews:"AvaliaÃ§Ãµes mÃ­n. ğŸ’¬", all:"Todas", applyFilters:"Aplicar filtros", clearFilters:"ğŸ§¹ Limpar",
            results:"RESULTADOS", exportPDF:"ğŸ“„ Exportar para PDF",
            updating:"ğŸ” Buscando novos lugares no Google Mapsâ€¦", filtersApplied:"âœ… Filtros aplicados aos resultados atuais.",
            dataUpdated:"âœ… Dados atualizados", lastUpdate:"Ãšltima atualizaÃ§Ã£o",
            noResults:"Sem resultados. FaÃ§a uma busca.", updateData:"Atualizar dados",
            help_title:"Ajuda",
            help_text:"1) Em â€˜Buscar lugaresâ€™, digite a palavra (opÃ§Ã£o: â€˜Tipo de lugarâ€™) e a cidade; clique â€˜Buscarâ€™. 2) Em â€˜Filtrosâ€™, ajuste nota e avaliaÃ§Ãµes e â€˜Aplicarâ€™. 3) Exporte PDF no cabeÃ§alho.",
            close:"Fechar", about_title:"Sobre", about_line1:"Um app para os melhores guias Edith e AarÃ³n", about_line2:"De seus amigos Lili e Gus",
            access_title:"Acessibilidade", access_select:"Selecione o idioma", access_es:"Espanhol", access_en:"InglÃªs", access_fr:"FrancÃªs", access_pt:"PortuguÃªs", access_theme:"Modo escuro",
            reports_title:"RelatÃ³rios", reports_line1:"Novidades em breve.", reports_line2:"Estamos trabalhando em relatÃ³rios personalizados!",
            info_title:"Detalhes do local", info_rating:"ClassificaÃ§Ã£o", info_reviews:"AvaliaÃ§Ãµes", info_price:"PreÃ§o", info_address:"EndereÃ§o", info_phone:"Telefone", info_hours:"HorÃ¡rio", info_map:"Abrir no Google Maps",
            footer_version:"VersÃ£o 50.1", expanded_prefix:"ğŸ” Busca ampliada:" }
    };

    /* ======= Equivalencias (comida + ocio + cultura) ======= */
    const equivalencias = {
      "taqueria":["tacos","taquerÃ­a","taquerÃ­as","taqueros"],
      "pizzeria":["pizza","pizzerÃ­a","pizzerÃ­as","pizzeria","pizzerias"],
      "hamburguesas":["hamburguesas","burger","hamburgueserÃ­a","hamburgueserias"],
      "sushi":["sushi","restaurante japonÃ©s","comida japonesa","ramen","izakaya","yakitori"],
      "mariscos":["mariscos","pescados","marisquerÃ­a","marisquerÃ­as"],
      "cafe":["cafÃ©","cafeterÃ­a","coffee shop","cafÃ©s de especialidad","barista"],
      "comida mexicana":["comida mexicana","antojitos","tacos","cocina mexicana"],
      "comida italiana":["comida italiana","trattoria","pasta","pizza"],
      "comida china":["comida china","chow mein","arroz frito","dim sum"],
      "comida americana":["comida americana","hamburguesas","bbq","alitas","hot dogs"],
      "comida india":["comida india","curry","masala","tandoori","hindÃº"],
      "comida vegana":["vegano","vegana","vegetariano","vegetariana","plant based","plant-based","saludable"],
      "postres":["postres","reposterÃ­a","pastelerÃ­a","dulces"],
      "bares":["bar","cantina","cervecerÃ­a","pub","mixologÃ­a","coctelerÃ­a"],
      "antros":["antro","discoteca","club nocturno","nightclub","dance club","disco"],
      "discos":["disco","discoteca","club","fiesta","dance floor"],
      "museos":["museo","galerÃ­a","galeria","exposiciÃ³n","exhibiciÃ³n","arte"]
    };

    /* ======= Listas para prefijos adaptativos ======= */
    const GENERIC_FOOD = [
      "tacos","taqueria","taquerÃ­a","taquerÃ­as","taqueros","pizza","pizzeria","pizzerÃ­a","pizzerÃ­as",
      "hamburguesas","sushi","mariscos","cafe","cafeteria","cafeterÃ­a","antojitos","restaurantes","carnes",
      "postres","panaderia","panaderÃ­a","vegano","vegetariano","pasta","italiana","china","india","americana","mexicana","ramen","bbq","alitas","hot dogs"
    ];
    const GENERIC_LEISURE = [
      "bares","bar","cantina","cerveceria","cervecerÃ­a","pub","pubs","antros","antro","discoteca","discotecas","discos","club","club nocturno","nightclub",
      "museos","museo","galeria","galerÃ­a","cine","teatro","exposiciÃ³n","exhibiciÃ³n","arte"
    ];

    /* ======= Utilidades ======= */
    function normalize(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();}
    function expandQueryTerms(raw){
      const base=normalize(raw||""); if(!base) return [];
      const set=new Set([base, ...base.split(/\s+/)]);
      const groups=Object.entries(equivalencias).map(([k,a])=>[normalize(k),...a.map(normalize)]);
      let changed=true, i=0;
      while(changed && i<2){changed=false; i++;
        for(const t of Array.from(set)){
          for(const g of groups){
            if(g.some(x=>t.includes(x) || x.includes(t))){
              for(const w of g){ if(!set.has(w)){ set.add(w); changed=true; } }
            }
          }
        }
      }
      return Array.from(set);
    }
    const looksGeneric = (term) => /^[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+$/.test(term.trim());
    const priceToSymbol = (lvl) => {
      const n = Number(lvl);
      return n===1 ? "$" : n===2 ? "$$" : n===3 ? "$$$" : n===4 ? "$$$$" : "â€”";
    };

    // Logo embebido (SVG negro) sÃ³lo para PDF â€” evita dependencia externa
    const LOGO_PDF_DATAURI =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="320" height="60">
        <rect width="100%" height="100%" fill="white"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="black">
          Recomendaciones de AarÃ³n
        </text>
      </svg>`);

    function App(){
      const [lang,setLang]=useState("es");                 // Siempre inicia en espaÃ±ol
      const [dark,setDark]=useState(false);                // Persistente
      const [openMenu,setOpenMenu]=useState(false);
      const [openHelp,setOpenHelp]=useState(false);
      const [openAbout,setOpenAbout]=useState(false);
      const [openReports,setOpenReports]=useState(false);
      const [openAccess,setOpenAccess]=useState(false);
      const [infoRow,setInfoRow]=useState(null);

      // ====== Estados de BÃºsqueda (Bloque A)
      const [city,setCity]=useState("Ciudad de MÃ©xico");
      const [query,setQuery]=useState("");
      const [placeType,setPlaceType]=useState(""); // nuevo selector de tipo
      const [showMoreTypes,setShowMoreTypes]=useState(false); // despliegue â€œMÃ¡s categorÃ­asâ€¦â€

      // ====== Estados de Filtros Locales (Bloque B)
      const [rows,setRows]=useState([]);
      const [tempMinRating,setTempMinRating]=useState("");
      const [tempMinReviews,setTempMinReviews]=useState("");
      const [minRating,setMinRating]=useState("");     // aplicados
      const [minReviews,setMinReviews]=useState("");   // aplicados

      const [loading,setLoading]=useState(false);
      const [message,setMessage]=useState("");
      const [lastUpdate,setLastUpdate]=useState("");
      const [expandedNotice,setExpandedNotice]=useState("");

      const t = (k)=> textos[lang][k] || k;

      // Dark mode persistente
      useEffect(()=>{ const saved=localStorage.getItem("aaron_dark")==="1"; setDark(saved); document.documentElement.classList.toggle("dark",saved); },[]);
      useEffect(()=>{ localStorage.setItem("aaron_dark",dark?"1":"0"); document.documentElement.classList.toggle("dark",dark); },[dark]);
      useEffect(()=>{ document.title=textos[lang].title; },[lang]);

      // Bloqueo scroll con modales
      useEffect(()=>{
        const anyOpen=openMenu||openHelp||openAbout||openReports||openAccess||!!infoRow;
        document.body.style.overflow= anyOpen ? "hidden":"auto";
        return ()=>{ document.body.style.overflow="auto"; };
      },[openMenu,openHelp,openAbout,openReports,openAccess,infoRow]);

      const formatMiles=(n)=> (n??0).toLocaleString(lang==="es"?"es-MX":lang==="pt"?"pt-BR":lang==="fr"?"fr-FR":"en-US");

      /* ======= BÃºsqueda ampliada + TYPE con caso â€œsolo tipoâ€ ======= */
      async function fetchPlaces(q) {
        setLoading(true);
        setMessage(t("updating"));
        try {
          const baseText = (q||"").trim();
          const noText = baseText.length===0;

          let queriesToRun = [];

          if (noText && placeType) {
            // âœ… Caso arreglado: solo tipo â†’ buscar por ciudad (texto simple) + type
            queriesToRun = [city];
            setExpandedNotice(""); // no mostrar bÃºsqueda ampliada en este caso
          } else {
            // BÃºsqueda ampliada con sinÃ³nimos
            const terms = expandQueryTerms(baseText || ((lang==="es"||lang==="pt")?"restaurantes":"restaurants"));
            const visible = terms.filter(Boolean).slice(0, 12);
            if (visible.length > 1) {
              setExpandedNotice(`${t("expanded_prefix")} ${visible.join(", ")}`);
              setTimeout(() => setExpandedNotice(""), 3000);
            } else {
              setExpandedNotice("");
            }
            queriesToRun = visible.length ? visible : [baseText];
          }

          const seen = new Map();

          for (const termRaw of queriesToRun) {
            const term = normalize(termRaw);

            const inFood = GENERIC_FOOD.some(w => term.includes(normalize(w)));
            const inLeisure = GENERIC_LEISURE.some(w => term.includes(normalize(w)));
            const genericByPattern = /^[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+$/.test(termRaw);

            // ConstrucciÃ³n textual final (cuando hay texto)
            let textQuery;
            if (noText && placeType){
              textQuery = city; // â–¶ï¸ clave del fix
            } else if ((inFood || genericByPattern) && !inLeisure) {
              textQuery = `restaurantes de ${termRaw} en ${city}`;
            } else if (inLeisure && !inFood) {
              textQuery = `lugares de ${termRaw} en ${city}`;
            } else {
              textQuery = `${termRaw} en ${city}`;
            }

            const url = API_BASE + "?q=" + encodeURIComponent(textQuery) + (placeType ? "&type="+encodeURIComponent(placeType) : "");
            const res = await fetch(url);
            const json = await res.json();
            const arr = (json.results || []).map((p, i) => ({
              id: p.place_id || `${term}_${i}`,
              nombre: p.name || "-",
              calificacion: p.rating ?? "-",
              reseÃ±as: p.user_ratings_total ?? 0,
              precio: p.price_level ?? null, // price_level
              direccion: p.formatted_address || p.vicinity || "-",
              lugarId: p.place_id || null,
              telefono: p.formatted_phone_number || null,
              horario: (p.opening_hours && p.opening_hours.weekday_text)
                ? p.opening_hours.weekday_text.join(" Â· ")
                : (p.opening_hours && typeof p.opening_hours.open_now==="boolean")
                    ? (p.opening_hours.open_now ? (lang==="es"?"Abierto ahora":"Open now") : (lang==="es"?"Cerrado":"Closed"))
                    : null,
              url: p.url || null,
              tipos: p.types || []
            }));

            for (const place of arr) {
              const key = (normalize(place.nombre || "-")) + "|" + (normalize(place.direccion || "-"));
              if (!seen.has(key)) {
                seen.set(key, place);
              } else {
                const prev = seen.get(key);
                if ((Number(place.calificacion)||0) > (Number(prev.calificacion)||0)) prev.calificacion = place.calificacion;
                if ((place.reseÃ±as||0) > (prev.reseÃ±as||0)) prev.reseÃ±as = place.reseÃ±as;
                if (prev.precio == null && place.precio != null) prev.precio = place.precio;
                seen.set(key, prev);
              }
            }
          }

          const data = Array.from(seen.values()).sort(
            (a, b) => (Number(b.calificacion) || 0) - (Number(a.calificacion) || 0)
          );

          setRows(data);
          setMessage(t("dataUpdated"));

          const now = new Date();
          const fecha = now.toLocaleDateString(lang === "es" ? "es-MX" : lang === "pt" ? "pt-BR" : lang === "fr" ? "fr-FR" : "en-US");
          const hora = now.toLocaleTimeString(lang === "es" ? "es-MX" : lang === "pt" ? "pt-BR" : lang === "fr" ? "fr-FR" : "en-US", { hour: '2-digit', minute: '2-digit' });
          setLastUpdate(`${fecha} ${hora}`);
        } catch (e) {
          console.error(e);
          setMessage(
            lang === "es" ? "Error al consultar la API. Revisa la API Key o los lÃ­mites de uso." :
            lang === "fr" ? "Erreur lors de lâ€™appel Ã  lâ€™API." :
            lang === "pt" ? "Erro ao consultar a API." :
            "API error. Check API key or usage limits."
          );
        } finally {
          setLoading(false);
        }
      }

      /* ======= FILTRO aplicado SOLO al presionar 'Aplicar filtros' ======= */
      const rowsFiltered = useMemo(()=>{
        // Filtra por rating + reseÃ±as, y si hay texto, por sinÃ³nimos en nombre/direcciÃ³n
        const terms = query ? expandQueryTerms(query) : [];
        return rows.filter(r=>{
          const name=normalize(r.nombre||"");
          const addr=normalize(r.direccion||"");
          const passName = terms.length ? terms.some(t => name.includes(t) || addr.includes(t)) : true;
          const passRating = minRating ? (Number(r.calificacion)>=Number(minRating)) : true;
          const passReviews = minReviews ? (Number(r.reseÃ±as) >= Number(minReviews)) : true;
          return passName && passRating && passReviews;
        });
      },[rows,query,minRating,minReviews]);

      // PDF que respeta el tema actual + logo embebido + fecha/hora
      const exportPDF = () => {
        const section = document.getElementById("results-section");
        if(!section){ return; }

        const wrapper = document.createElement("div");
        wrapper.style.padding = "10px";
        wrapper.style.fontFamily = "Arial, sans-serif";

        if (document.documentElement.classList.contains("dark")) {
          wrapper.classList.add("dark");
          wrapper.style.backgroundColor = "#000";
          wrapper.style.color = "#fff";
        } else {
          wrapper.style.backgroundColor = "#fff";
          wrapper.style.color = "#000";
        }

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.gap = "12px";
        header.style.marginBottom = "12px";

        const img = document.createElement("img");
        img.src = LOGO_PDF_DATAURI;
        img.style.height = "40px";
        img.style.width = "auto";

        const titleBox = document.createElement("div");
        const h = document.createElement("div");
        h.style.fontWeight = "700";
        h.style.fontSize = "18px";
        h.textContent = textos[lang].title;

        const now = new Date();
        const fecha = now.toLocaleDateString(lang==="es"?"es-MX":lang==="pt"?"pt-BR":lang==="fr"?"fr-FR":"en-US");
        const hora = now.toLocaleTimeString(lang==="es"?"es-MX":lang==="pt"?"pt-BR":lang==="fr"?"fr-FR":"en-US",{hour:'2-digit',minute:'2-digit'});

        const s = document.createElement("div");
        s.style.fontSize = "12px";
        s.textContent = (lang==="es" ? "Exportado: " :
                        lang==="fr" ? "ExportÃ© : " :
                        lang==="pt" ? "Exportado: " : "Exported: ") + `${fecha} ${hora}`;

        titleBox.appendChild(h);
        titleBox.appendChild(s);
        header.appendChild(img);
        header.appendChild(titleBox);

        const clone = section.cloneNode(true);

        if (wrapper.classList.contains("dark")) {
          clone.querySelectorAll("table, th, td").forEach(el=>{
            el.style.backgroundColor = el.tagName==="TH" ? "#1a1a1a" : "#0d0d0d";
            el.style.color = "#f2f2f2";
            el.style.borderColor = "#333";
          });
          clone.querySelectorAll(".bg-blue-600").forEach(el=>{ el.style.backgroundColor="#0057d9"; el.style.color="#fff"; });
          clone.querySelectorAll(".bg-blue-100").forEach(el=>{ el.style.backgroundColor="#1a1a1a"; el.style.color="#f2f2f2"; });
          clone.querySelectorAll(".text-blue-700, .text-blue-600").forEach(el=>{ el.style.color="#5ea0ff"; });
        }

        wrapper.appendChild(header);
        wrapper.appendChild(clone);
        document.body.appendChild(wrapper);

        const filename = `reporte_recomendaciones_${fecha}_${hora.replace(':','-')}.pdf`;
        html2pdf().set({
          margin: 10,
          filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(wrapper)
        .save()
        .then(()=> { document.body.removeChild(wrapper); })
        .catch(()=> { document.body.removeChild(wrapper); });
      };

      const applyFilters = ()=>{
        setMinRating(tempMinRating);
        setMinReviews(tempMinReviews);
        setMessage(t("filtersApplied"));
        setTimeout(()=>setMessage(""), 2500);
      };

      const clearFilters = ()=>{
        setTempMinRating(""); setTempMinReviews("");
        setMinRating(""); setMinReviews("");
        setMessage(t("filtersApplied"));
        setTimeout(()=>setMessage(""), 1200);
      };

      const resetHome=()=>{
        setOpenMenu(false);
        setQuery(""); setCity("Ciudad de MÃ©xico"); setPlaceType(""); setShowMoreTypes(false);
        setRows([]); setMessage(""); setExpandedNotice(""); setLastUpdate(""); setInfoRow(null);
        setTempMinRating(""); setTempMinReviews(""); setMinRating(""); setMinReviews("");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="bg-blue-600 text-white px-4 py-3 shadow-md flex items-center gap-3">
            <button onClick={()=>setOpenMenu(true)} className="text-2xl hover:opacity-80" aria-label="Abrir menÃº">â˜°</button>
            <img src="logo.png" alt="Logo" className="h-12 w-auto" />
            <h1 className="text-xl font-bold">{t("title")}</h1>
            <div className="ml-auto">
              <button onClick={()=>setDark(!dark)} className="text-white text-xl" title={textos[lang].access_theme}>ğŸŒ“</button>
            </div>
          </header>

          {/* Backdrop MenÃº */}
          {openMenu && <div className="fixed inset-0 bg-black/40 z-40" onClick={()=>setOpenMenu(false)}></div>}

          {/* MenÃº lateral */}
          <aside className={"fixed top-0 left-0 z-50 bg-white w-64 h-full shadow-xl menu-panel "+(openMenu?"open":"")}>
            <div className="p-4 border-b flex items-center justify-between">
              <span className="font-semibold">MenÃº</span>
              <button onClick={()=>setOpenMenu(false)} className="text-lg" aria-label="Cerrar">âœ•</button>
            </div>
            <nav className="p-4 space-y-3 text-gray-700">
              <div className="hover:underline cursor-pointer" onClick={resetHome}>{t("menu_home")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenReports(true); setOpenMenu(false);}}>{t("menu_reports")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenHelp(true); setOpenMenu(false);}}>{t("menu_help")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenAccess(true); setOpenMenu(false);}}>{t("menu_access")}</div>
              <div className="hover:underline cursor-pointer" onClick={()=>{setOpenAbout(true); setOpenMenu(false);}}>{t("menu_about")}</div>
            </nav>
          </aside>

          {/* ğŸ”µ BLOQUE A â€” BÃšSQUEDA PRINCIPAL */}
          <section className="max-w-6xl mx-auto mt-6 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-4">
              <h2 className="text-lg font-semibold text-blue-700">ğŸ” {t("searchBtn")}</h2>
              <div className="flex flex-col md:flex-row gap-3 items-start md:items-end">
                <div className="w-full md:w-1/4">
                  <label className="block text-sm text-gray-600 mb-1">{t("city")}</label>
                  <select value={city} onChange={(e)=>setCity(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option>Ciudad de MÃ©xico</option>
                    <option>Guadalajara</option>
                    <option>Monterrey</option>
                  </select>
                </div>

                <div className="flex-1 w-full">
                  <label className="block text-sm text-gray-600 mb-1">{t("query")}</label>
                  <input
                    type="text"
                    value={query}
                    onChange={(e)=>setQuery(e.target.value)}
                    onKeyDown={(e)=>{ if(e.key==="Enter") fetchPlaces(query); }}
                    placeholder={lang==="es"?"Ej. 'taquerÃ­as', 'museos', 'pizza'â€¦":(lang==="fr"?"ex. 'pizzerias', 'musÃ©es'â€¦":"e.g. 'tacos', 'museums', 'pizza'â€¦")}
                    className="border rounded-lg p-2 w-full shadow-sm"
                  />
                </div>

                <div className="w-full md:w-64">
                  <label className="block text-sm text-gray-600 mb-1">{t("type")}</label>
                  <select value={placeType} onChange={(e)=>setPlaceType(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{textos[lang].all}</option>
                    <option value="restaurant">ğŸ½ï¸ Restaurante</option>
                    <option value="cafe">â˜• CafeterÃ­a</option>
                    <option value="bar">ğŸº Bar / Cantina</option>
                    <option value="night_club">ğŸ¸ Antro / Club</option>
                    <option value="bakery">ğŸ¥ PanaderÃ­a</option>
                    <option value="meal_takeaway">ğŸ± Comida para llevar</option>
                    <option value="meal_delivery">ğŸ• Comida a domicilio</option>
                    <option value="museum">ğŸ›ï¸ Museo</option>
                    <option value="art_gallery">ğŸ¨ GalerÃ­a de arte</option>
                    <option value="tourist_attraction">ğŸï¸ AtracciÃ³n turÃ­stica</option>
                    <option value="lodging">ğŸ¨ Hotel / Hospedaje</option>
                    <option value="shopping_mall">ğŸ›ï¸ Centro comercial</option>
                    <option value="gym">ğŸ’ª Gimnasio</option>
                    <option value="beauty_salon">ğŸ’‡â€â™€ï¸ SalÃ³n de belleza</option>
                    <option value="movie_theater">ğŸ­ Cine / Teatro</option>
                  </select>

                  {/* MÃ¡s categorÃ­as */}
                  <button className="text-blue-600 underline mt-2" onClick={()=>setShowMoreTypes(!showMoreTypes)}>{t("moreTypes")}</button>
                  {showMoreTypes && (
                    <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("park")}>ğŸï¸ Parque</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("store")}>ğŸª Tienda</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("gas_station")}>â›½ Gasolinera</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("pharmacy")}>ğŸ’Š Farmacia</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("hospital")}>ğŸ¥ Hospital</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("church")}>â›ª Iglesia</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("bank")}>ğŸ¦ Banco</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("atm")}>ğŸ§ Cajero</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("car_repair")}>ğŸ”§ Taller mecÃ¡nico</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("car_rental")}>ğŸš™ Renta de autos</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("airport")}>âœˆï¸ Aeropuerto</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("bus_station")}>ğŸšŒ Terminal</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("train_station")}>ğŸš† EstaciÃ³n</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("electronics_store")}>ğŸ’» ElectrÃ³nica</button>
                      <button className="border rounded p-1 hover:bg-gray-50" onClick={()=>setPlaceType("supermarket")}>ğŸ›’ Supermercado</button>
                    </div>
                  )}
                </div>

                <div className="flex gap-2">
                  <button onClick={()=>fetchPlaces(query)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">{t("searchBtn")}</button>
                </div>
              </div>
            </div>
          </section>

          {/* ğŸŸ¤ BLOQUE B â€” FILTROS LOCALES */}
          <section className="max-w-6xl mx-auto mt-4 px-4">
            <div className="bg-white rounded-xl shadow p-4 space-y-3">
              <h2 className="text-lg font-semibold text-gray-700">ğŸ§© Filtros (sobre resultados actuales)</h2>
              <div className="flex flex-col md:flex-row gap-3 items-end">
                <div className="w-full md:w-56">
                  <label className="block text-sm text-gray-600 mb-1">{t("minRating")}</label>
                  <select value={tempMinRating} onChange={(e)=>setTempMinRating(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{textos[lang].all}</option>
                    <option value="4.0">4.0+</option>
                    <option value="4.2">4.2+</option>
                    <option value="4.4">4.4+</option>
                    <option value="4.6">4.6+</option>
                    <option value="4.8">4.8+</option>
                  </select>
                </div>
                <div className="w-full md:w-56">
                  <label className="block text-sm text-gray-600 mb-1">{t("minReviews")}</label>
                  <select value={tempMinReviews} onChange={(e)=>setTempMinReviews(e.target.value)} className="border rounded-lg p-2 w-full shadow-sm">
                    <option value="">{textos[lang].all}</option>
                    <option value="1000">1,000+</option>
                    <option value="5000">5,000+</option>
                    <option value="10000">10,000+</option>
                    <option value="15000">15,000+</option>
                    <option value="20000">20,000+</option>
                    <option value="25000">25,000+</option>
                    <option value="30000">30,000+</option>
                  </select>
                </div>
                <div className="flex gap-2">
                  <button onClick={applyFilters} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">{t("applyFilters")}</button>
                  <button onClick={clearFilters} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">{t("clearFilters")}</button>
                </div>
              </div>
            </div>
          </section>

          {/* Mensaje arriba de la tabla */}
          <section className="max-w-6xl mx-auto px-4 mt-3">
            {loading && <div className="text-blue-700 bg-blue-50 border border-blue-200 rounded p-2 text-sm">{t("updating")}</div>}
            {!loading && message && <div className="text-green-700 bg-green-50 border border-green-200 rounded p-2 text-sm">{message}</div>}
          </section>
{/* Resultados */}
          <section id="results-section" className="max-w-6xl mx-auto mt-3 px-4">
            <div className="bg-white rounded-xl shadow overflow-hidden">
              <div className="bg-blue-600 text-white px-4 py-3 font-semibold flex justify-between items-center">
                <span>{t("results")}</span>
                <button onClick={exportPDF} className="bg-white text-blue-700 font-semibold px-3 py-1 rounded hover:bg-blue-50 text-sm">{t("exportPDF")}</button>
              </div>

              {expandedNotice && (
                <div className="px-4 py-2 bg-blue-100 text-blue-800 border-t border-b border-blue-200 text-sm">
                  {expandedNotice}
                </div>
              )}

              <div className="p-4 overflow-x-auto">
                <table className="min-w-full text-sm border">
                  <thead className="bg-blue-100">
                    <tr>
                      <th className="border p-2 text-center">#</th>
                      <th className="border p-2 text-left">ğŸ  {lang==="es"?"Lugar":lang==="fr"?"Nom":"Place"}</th>
                      <th className="border p-2 text-center">â­ {lang==="es"?"CalificaciÃ³n":lang==="fr"?"Note":"Rating"}</th>
                      <th className="border p-2 text-center">ğŸ’² {textos[lang].info_price}</th>
                      <th className="border p-2 text-center">ğŸ’¬ {lang==="es"?"ReseÃ±as":lang==="fr"?"Avis":"Reviews"}</th>
                      <th className="border p-2 text-left">ğŸ“ {lang==="es"?"DirecciÃ³n":lang==="fr"?"Adresse":"Address"}</th>
                      <th className="border p-2 text-center">ğŸ”— {lang==="es"?"Ver mapa":lang==="fr"?"Ouvrir carte":"Open map"}</th>
                      <th className="border p-2 text-center">â„¹ï¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rowsFiltered.map((r, idx)=>(
                      <tr key={idx} className="hover:bg-blue-50 transition-all">
                        <td className="border p-2 text-center">{idx+1}</td>
                        <td className="border p-2">
                          <div className="font-medium">{r.nombre}</div>
                        </td>
                        <td className="border p-2 text-center">{r.calificacion}</td>
                        <td className="border p-2 text-center">{priceToSymbol(r.precio)}</td>
                        <td className="border p-2 text-center">{formatMiles(r.reseÃ±as)}</td>
                        <td className="border p-2">{r.direccion}</td>
                        <td className="border p-2 text-center">
                          <a href={"https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent((r.nombre||"")+" "+(r.direccion||""))}
                             target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                            {lang==="es"?"Abrir":lang==="fr"?"Ouvrir":"Open"}
                          </a>
                        </td>
                        <td className="border p-2 text-center">
                          <button className="underline text-blue-600 hover:opacity-80" onClick={()=>setInfoRow(r)}>â„¹ï¸</button>
                        </td>
                      </tr>
                    ))}
                    {rowsFiltered.length===0 && (
                      <tr>
                        <td colSpan="8" className="text-center text-gray-500 p-6">{t("noResults")}</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="flex flex-col items-center justify-center mt-6 mb-10">
              {lastUpdate && (
                <p className="text-gray-500 text-sm mt-1">{t("lastUpdate")}: {lastUpdate}</p>
              )}
            </div>
          </section>

          {/* Modales */}
          {openHelp && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("help_title")}</h2>
                <p className="text-sm text-gray-700 mb-4">{t("help_text")}</p>
                <button onClick={()=>setOpenHelp(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openAbout && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("about_title")}</h2>
                <p className="text-gray-700 mb-4">{textos[lang].about_line1}<br/>{textos[lang].about_line2}</p>
                <button onClick={()=>setOpenAbout(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openReports && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{textos[lang].reports_title}</h2>
                <p className="text-gray-700 mb-1">{textos[lang].reports_line1}</p>
                <p className="text-gray-700 mb-4">{textos[lang].reports_line2}</p>
                <button onClick={()=>setOpenReports(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {openAccess && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 text-center">
                <h2 className="text-xl font-semibold mb-3 text-blue-600">{t("access_title")}</h2>
                <p className="text-sm text-gray-700 mb-4">{t("access_select")}</p>

                <div className="flex items-center justify-center gap-4 mb-4">
                  <label className="inline-flex items-center gap-2"><input type="radio" name="lang1" checked={lang==="es"} onChange={()=>setLang("es")}/><span>{textos.es.access_es}</span></label>
                  <label className="inline-flex items-center gap-2"><input type="radio" name="lang1" checked={lang==="en"} onChange={()=>setLang("en")}/><span>{textos.en.access_en}</span></label>
                </div>
                <div className="flex items-center justify-center gap-4 mb-6">
                  <label className="inline-flex items-center gap-2"><input type="radio" name="lang2" checked={lang==="fr"} onChange={()=>setLang("fr")}/><span>{textos.fr.access_fr}</span></label>
                  <label className="inline-flex items-center gap-2"><input type="radio" name="lang2" checked={lang==="pt"} onChange={()=>setLang("pt")}/><span>{textos.pt.access_pt}</span></label>
                </div>

                <div className="flex items-center justify-center gap-3 mb-6">
                  <input id="darkmode" type="checkbox" checked={dark} onChange={()=>setDark(!dark)} />
                  <label htmlFor="darkmode">{textos[lang].access_theme}</label>
                </div>

                <button onClick={()=>setOpenAccess(false)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
              </div>
            </div>
          )}

          {/* Modal â„¹ï¸ */}
          {infoRow && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
                <h3 className="text-lg font-semibold text-blue-600 mb-2">{t("info_title")}</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                  <div><b>ğŸ  {lang==="es"?"Nombre":lang==="fr"?"Nom":"Name"}:</b> {infoRow.nombre}</div>
                  <div><b>â­ {t("info_rating")}:</b> {infoRow.calificacion || "â€”"}</div>
                  <div className="sm:col-span-2"><b>ğŸ“ {t("info_address")}:</b> {infoRow.direccion || "â€”"}</div>
                  <div><b>ğŸ’² {t("info_price")}:</b> {priceToSymbol(infoRow.precio)}</div>
                  <div><b>ğŸ“ {t("info_phone")}:</b> {infoRow.telefono || "â€”"}</div>
                  <div className="sm:col-span-2"><b>â° {t("info_hours")}:</b> {infoRow.horario || "â€”"}</div>
                  <div className="sm:col-span-2">
                    <a className="text-blue-600 underline"
                      href={"https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent((infoRow.nombre||"")+" "+(infoRow.direccion||""))}
                      target="_blank" rel="noopener noreferrer">ğŸ”— {t("info_map")}
                    </a>
                  </div>
                </div>
                <div className="mt-4 text-right">
                  <button onClick={()=>setInfoRow(null)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">{t("close")}</button>
                </div>
              </div>
            </div>
          )}

          {/* Footer */}
          <footer className="mt-10 p-4 text-center text-gray-500 text-sm flex flex-col md:flex-row justify-between items-center border-t border-gray-200">
            <span>Â© 2025 {t("title")} â€” {lang==="es"?"Todos los derechos reservados.":lang==="fr"?"Tous droits rÃ©servÃ©s.":lang==="pt"?"Todos os direitos reservados.":"All rights reserved."}</span>
            <span className="text-right font-semibold text-gray-600">{textos[lang].footer_version}</span>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>