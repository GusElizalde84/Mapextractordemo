<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendaciones de Aar√≥n</title>

  <!-- Tailwind (dark mode por clase) -->
  <script>tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel + html2pdf -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto', sans-serif; }
    .menu-panel { transform: translateX(-100%); transition: transform .3s ease; }
    .menu-panel.open { transform: translateX(0); }

    /* üåô Modo oscuro */
    .dark { background-color: #000 !important; color: #fff !important; }
    .dark .bg-white { background-color: #111 !important; }
    .dark input, .dark select { background-color: #222 !important; color: #fff !important; border-color: #444 !important; }
    .dark table th { background-color: #1a1a1a !important; color: #fff !important; }
    .dark table td { background-color: #0d0d0d !important; color: #eee !important; }
    .dark .bg-blue-600 { background-color: #2563eb !important; color: #fff !important; }

    /* Spinner */
    .spinner { width: 28px; height: 28px; border: 3px solid #93c5fd; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast */
    .toast {
      position: fixed; left: 50%; top: 20%; transform: translate(-50%, -50%);
      background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; z-index: 60;
      box-shadow: 0 8px 24px rgba(0,0,0,.25); opacity: 0; animation: fade 2.4s ease forwards;
    }
    .toast.warn { background:#b91c1c; }
    @keyframes fade { 5% {opacity:1} 85% {opacity:1} 100%{opacity:0} }

    /* PDF sin cortes */
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
const { useState, useEffect, useMemo } = React;
    const API_BASE = "https://aaronbestplaces.vercel.app/api/lugares";

    /* ======= Textos ======= */
    const TEXTS = {
      es: {
        title:"Recomendaciones de Aar√≥n",
        menu_home:"üè† Inicio", menu_reports:"üìä Reportes", menu_help:"‚ùì Ayuda", menu_access:"üåê Accesibilidad", menu_about:"‚ÑπÔ∏è Acerca de",
        city:"Ciudad", query:"Consulta", type:"Tipo de lugar", moreTypes:"M√°s categor√≠as‚Ä¶", searchBtn:"Buscar lugares",
        minRating:"Calificaci√≥n m√≠nima ‚≠ê", minReviews:"Rese√±as m√≠nimas üí¨", all:"Todas", applyFilters:"Aplicar filtros", clearFilters:"üßπ Limpiar todo",
        results:"RESULTADOS", exportPDF:"üìÑ Exportar a PDF",
        updating:"üîé Consultando nuevos lugares en Google Maps‚Ä¶", filtersApplied:"‚úÖ Filtros aplicados sobre los resultados actuales.",
        dataUpdated:"‚úÖ Datos actualizados correctamente", lastUpdate:"√öltima actualizaci√≥n",
        noResults:"Sin resultados. Usa el buscador para traer datos de Google Maps.",
        help_title:"Ayuda",
        help_text:"1) En ‚ÄòBuscar lugares‚Äô, escribe el nombre o palabra (opcional: selecciona ‚ÄòTipo de lugar‚Äô) y la ciudad; presiona ‚ÄòBuscar lugares‚Äô. 2) En ‚ÄòFiltros‚Äô, ajusta calificaci√≥n y rese√±as y presiona ‚ÄòAplicar filtros‚Äô. 3) Exporta a PDF en el encabezado de resultados.",
        close:"Cerrar", about_title:"Acerca de", about_line1:"Una aplicaci√≥n para los mejores gu√≠as Edith y Aar√≥n", about_line2:"De sus amigos Lili y Gus",
        access_title:"Accesibilidad", access_select:"Selecciona el idioma", access_es:"Espa√±ol", access_en:"English",
        access_theme:"Modo oscuro", reports_title:"Reportes", reports_line1:"Pr√≥ximamente habr√° novedades en esta secci√≥n.",
        reports_line2:"¬°Estamos trabajando para ofrecerte reportes y estad√≠sticas personalizadas!",
        info_title:"Detalles del lugar", info_rating:"Calificaci√≥n", info_reviews:"Rese√±as", info_price:"Precio",
        info_address:"Direcci√≥n", info_phone:"Tel√©fono", info_hours:"Horario", info_map:"Abrir en Google Maps",
        footer_version:"Versi√≥n 50.7", expanded_prefix:"üîç B√∫squeda ampliada:", results_count:"lugares encontrados"
      },
      en: {
        title:"Aaron‚Äôs Recommendations",
        menu_home:"üè† Home", menu_reports:"üìä Reports", menu_help:"‚ùì Help", menu_access:"üåê Accessibility", menu_about:"‚ÑπÔ∏è About",
        city:"City", query:"Query", type:"Place type", moreTypes:"More categories‚Ä¶", searchBtn:"Search places",
        minRating:"Min rating ‚≠ê", minReviews:"Min reviews üí¨", all:"All", applyFilters:"Apply filters", clearFilters:"üßπ Clear all",
        results:"RESULTS", exportPDF:"üìÑ Export to PDF", updating:"üîé Fetching new places from Google Maps‚Ä¶",
        filtersApplied:"‚úÖ Filters applied to current results.", dataUpdated:"‚úÖ Data updated successfully",
        lastUpdate:"Last update", noResults:"No results found.",
        help_title:"Help", help_text:"1) In ‚ÄòSearch places‚Äô, type a name or keyword (optional: select ‚ÄòPlace type‚Äô) and the city; press ‚ÄòSearch places‚Äô. 2) In ‚ÄòFilters‚Äô, adjust rating and reviews and press ‚ÄòApply filters‚Äô. 3) Export to PDF at the results header.",
        close:"Close", about_title:"About", about_line1:"An app for the best guides Edith and Aar√≥n", about_line2:"From their friends Lili and Gus",
        access_title:"Accessibility", access_select:"Select language", access_es:"Spanish", access_en:"English",
        access_theme:"Dark mode", reports_title:"Reports", reports_line1:"Coming soon‚Ä¶", reports_line2:"We‚Äôre working on reports and statistics!",
        info_title:"Details", info_rating:"Rating", info_reviews:"Reviews", info_price:"Price", info_address:"Address",
        info_phone:"Phone", info_hours:"Hours", info_map:"Open in Google Maps", footer_version:"Version 50.7",
        expanded_prefix:"üîç Expanded search:", results_count:"places found"
      }
    };

    const equivalencias = {
      "taqueria":["tacos","taquer√≠a","taquer√≠as","taqueros"],
      "pizzeria":["pizza","pizzer√≠a","pizzer√≠as","pizzeria","pizzerias"],
      "hamburguesas":["hamburguesas","burger","hamburgueser√≠a","hamburgueserias"],
      "sushi":["sushi","restaurante japon√©s","comida japonesa","ramen","izakaya","yakitori"],
      "mariscos":["mariscos","pescados","marisquer√≠a","marisquer√≠as"],
      "cafe":["caf√©","cafeter√≠a","coffee shop","caf√©s de especialidad","barista"],
      "comida mexicana":["comida mexicana","antojitos","tacos","cocina mexicana"],
      "comida italiana":["comida italiana","trattoria","pasta","pizza"],
      "bares":["bar","cantina","cervecer√≠a","pub","mixolog√≠a","cocteler√≠a"],
      "antros":["antro","discoteca","club nocturno","nightclub","dance club","disco"],
      "museos":["museo","galer√≠a","exposici√≥n","arte"]
    };

    const normalize = (s)=> (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const expandQueryTerms = (raw) => {
      const base = normalize(raw || "");
      if (!base) return [];
      const set = new Set([base, ...base.split(/\s+/)]);
      for (const [k, arr] of Object.entries(equivalencias)) {
        if (set.has(normalize(k))) arr.forEach(a => set.add(normalize(a)));
        arr.forEach(a => { if (set.has(normalize(a))) set.add(normalize(k)); });
      }
      return Array.from(set);
    };

    const priceToSymbol = (n) => n === 1 ? "$" : n === 2 ? "$$" : n === 3 ? "$$$" : n === 4 ? "$$$$" : "‚Äî";

    const buildPdfLogoDataURL = () => {
      const canvas = document.createElement("canvas");
      canvas.width = 900; canvas.height = 140;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "bold 52px Arial, Helvetica, sans-serif";
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText("Recomendaciones de Aar√≥n", canvas.width / 2, canvas.height / 2);
      return canvas.toDataURL("image/png");
    };

    const PLACEHOLDER_IMG =
      "data:image/svg+xml;utf8," +
      encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='18' fill='#6b7280'>üèôÔ∏è</text></svg>`
      );

    function App() {
      const [lang, setLang] = useState("es");
      const [dark, setDark] = useState(false);
      const [rows, setRows] = useState([]);
      const [query, setQuery] = useState("");
      const [city, setCity] = useState("Ciudad de M√©xico");
      const [loading, setLoading] = useState(false);
      const [message, setMessage] = useState("");
      const [toast, setToast] = useState("");
      const [lastUpdate, setLastUpdate] = useState("");
      const [minRating, setMinRating] = useState("");
      const [minReviews, setMinReviews] = useState("");
      const [filtered, setFiltered] = useState([]);

      const t = (k) => TEXTS[lang][k] || k;

      useEffect(() => {
        const saved = localStorage.getItem("darkMode") === "1";
        setDark(saved);
        document.documentElement.classList.toggle("dark", saved);
      }, []);
      useEffect(() => {
        localStorage.setItem("darkMode", dark ? "1" : "0");
        document.documentElement.classList.toggle("dark", dark);
      }, [dark]);

      const showToast = (text, warn = false) => {
        setToast({ text, warn });
        setTimeout(() => setToast(""), 2500);
      };

      const fetchPlaces = async () => {
        if (!query.trim()) {
          showToast("‚ö†Ô∏è Escribe una consulta.", true);
          return;
        }
        setLoading(true);
        setMessage(t("updating"));
        try {
          const url = `${API_BASE}?q=${encodeURIComponent(query + " en " + city)}`;
          const res = await fetch(url);
          const data = await res.json();
          const arr = (data.results || []).map((p, i) => ({
            id: p.place_id || i,
            nombre: p.name,
            calificacion: p.rating || "‚Äî",
            rese√±as: p.user_ratings_total || 0,
            precio: p.price_level,
            direccion: p.formatted_address,
            icono: p.icon,
          }));
          setRows(arr);
          setFiltered(arr);
          setMessage(t("dataUpdated"));
          setLastUpdate(new Date().toLocaleString("es-MX"));
        } catch {
          setMessage("‚ùå Error");
        } finally {
          setLoading(false);
        }
      };

      const applyFilters = () => {
        const result = rows.filter((r) => {
          const ratingOK = !minRating || Number(r.calificacion) >= Number(minRating);
          const reviewsOK = !minReviews || Number(r.rese√±as) >= Number(minReviews);
          return ratingOK && reviewsOK;
        });
        setFiltered(result);
        showToast("Filtros aplicados ‚úîÔ∏è");
      };

      const clearAll = () => {
        setQuery("");
        setRows([]);
        setFiltered([]);
        setMinRating("");
        setMinReviews("");
        setMessage("");
        showToast("Limpieza completa ‚úîÔ∏è");
      };
const exportPDF = () => {
        const wrapper = document.createElement("div");
        wrapper.style.padding = "10px";
        wrapper.style.fontFamily = "Arial";
        wrapper.style.color = dark ? "#fff" : "#000";
        wrapper.style.backgroundColor = dark ? "#000" : "#fff";

        const header = document.createElement("div");
        header.style.textAlign = "center";
        const img = document.createElement("img");
        img.src = buildPdfLogoDataURL();
        img.style.width = "320px";
        img.style.height = "auto";
        header.appendChild(img);
        wrapper.appendChild(header);

        const filters = document.createElement("p");
        filters.style.fontSize = "12px";
        filters.textContent = `Ciudad: ${city} | Calificaci√≥n: ${minRating || "‚Äî"} | Rese√±as: ${minReviews || "‚Äî"}`;
        wrapper.appendChild(filters);

        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.style.fontSize = "12px";

        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        ["#", "Lugar", "Calificaci√≥n", "Precio", "Rese√±as", "Direcci√≥n"].forEach((txt) => {
          const th = document.createElement("th");
          th.textContent = txt;
          th.style.border = "1px solid #ccc";
          th.style.padding = "6px";
          thead.appendChild(th);
        });
        trh.appendChild(thead);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        filtered.forEach((r, i) => {
          const tr = document.createElement("tr");
          [i + 1, r.nombre, r.calificacion, priceToSymbol(r.precio), r.rese√±as, r.direccion].forEach((val) => {
            const td = document.createElement("td");
            td.textContent = val;
            td.style.border = "1px solid #ccc";
            td.style.padding = "4px";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrapper.appendChild(table);

        const footer = document.createElement("div");
        footer.style.fontSize = "10px";
        footer.style.textAlign = "right";
        footer.textContent = "Generado con Recomendaciones de Aar√≥n v50.7";
        wrapper.appendChild(footer);

        document.body.appendChild(wrapper);

        html2pdf()
          .set({
            margin: 10,
            filename: "reporte_recomendaciones.pdf",
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            pagebreak: { mode: ["avoid-all", "css", "legacy"] },
          })
          .from(wrapper)
          .save()
          .then(() => {
            console.log("‚úÖ Exportaci√≥n PDF completada correctamente");
            document.body.removeChild(wrapper);
          });
      };

      return (
        <div className="min-h-screen bg-gray-50 text-gray-800">
          <header className="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
            <h1 className="text-lg font-bold">Recomendaciones de Aar√≥n</h1>
            <button onClick={() => setDark(!dark)} className="text-xl">üåì</button>
          </header>

          <main className="max-w-6xl mx-auto p-4 space-y-4">
            <section className="bg-white rounded-xl shadow p-4">
              <h2 className="text-blue-700 font-semibold mb-3">Buscar lugares</h2>
              <div className="flex flex-col md:flex-row gap-3">
                <input
                  type="text"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="Ej. tacos, museos, Casa de To√±o‚Ä¶"
                  className="border rounded p-2 flex-1"
                />
                <select
                  value={city}
                  onChange={(e) => setCity(e.target.value)}
                  className="border rounded p-2 w-48"
                >
                  <option>Ciudad de M√©xico</option>
                  <option>Guadalajara</option>
                  <option>Monterrey</option>
                </select>
                <button
                  onClick={fetchPlaces}
                  className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                >
                  {t("searchBtn")}
                </button>
                {loading && <div className="spinner"></div>}
              </div>
            </section>

            <section className="bg-white rounded-xl shadow p-4">
              <h3 className="text-gray-700 font-semibold mb-2">Filtros</h3>
              <div className="flex flex-col md:flex-row gap-3 items-end">
                <div>
                  <label>Calificaci√≥n m√≠nima</label>
                  <select
                    value={minRating}
                    onChange={(e) => setMinRating(e.target.value)}
                    className="border rounded p-2 ml-2"
                  >
                    <option value="">Todas</option>
                    <option value="4.0">4.0+</option>
                    <option value="4.5">4.5+</option>
                    <option value="4.8">4.8+</option>
                  </select>
                </div>
                <div>
                  <label>Rese√±as m√≠nimas</label>
                  <select
                    value={minReviews}
                    onChange={(e) => setMinReviews(e.target.value)}
                    className="border rounded p-2 ml-2"
                  >
                    <option value="">Todas</option>
                    <option value="1000">1,000+</option>
                    <option value="5000">5,000+</option>
                    <option value="10000">10,000+</option>
                  </select>
                </div>
                <button
                  onClick={applyFilters}
                  className="px-3 py-2 border rounded hover:bg-gray-100"
                >
                  Aplicar filtros
                </button>
                <button
                  onClick={clearAll}
                  className="px-3 py-2 border rounded hover:bg-gray-100"
                >
                  Limpiar todo
                </button>
              </div>
            </section>
<section className="bg-white rounded-xl shadow p-4">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-blue-700 font-semibold">Resultados</h3>
                <button
                  onClick={exportPDF}
                  className="bg-white border border-blue-600 text-blue-700 px-3 py-1 rounded hover:bg-blue-50"
                >
                  üìÑ Exportar a PDF
                </button>
              </div>

              {message && (
                <div className="bg-green-50 text-green-700 border border-green-200 p-2 rounded mb-3 text-sm">
                  {message}
                </div>
              )}

              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border">
                  <thead className="bg-blue-100">
                    <tr>
                      <th className="border p-2 text-center">#</th>
                      <th className="border p-2 text-left">üè† Lugar</th>
                      <th className="border p-2 text-center">‚≠ê Calificaci√≥n</th>
                      <th className="border p-2 text-center">üí≤ Precio</th>
                      <th className="border p-2 text-center">üí¨ Rese√±as</th>
                      <th className="border p-2 text-left">üìç Direcci√≥n</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.length > 0 ? (
                      filtered.map((r, i) => (
                        <tr key={i} className="hover:bg-blue-50">
                          <td className="border p-2 text-center">{i + 1}</td>
                          <td className="border p-2">
                            <div className="flex items-center gap-2">
                              <img
                                src={r.icono || PLACEHOLDER_IMG}
                                alt=""
                                className="w-6 h-6 rounded-sm object-contain bg-white border"
                              />
                              <span>{r.nombre}</span>
                            </div>
                          </td>
                          <td className="border p-2 text-center">{r.calificacion}</td>
                          <td className="border p-2 text-center">{priceToSymbol(r.precio)}</td>
                          <td className="border p-2 text-center">{r.rese√±as.toLocaleString("es-MX")}</td>
                          <td className="border p-2">{r.direccion}</td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="text-center text-gray-500 p-4">
                          No hay resultados.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              {lastUpdate && (
                <p className="text-gray-500 text-sm mt-3 text-right">
                  √öltima actualizaci√≥n: {lastUpdate}
                </p>
              )}
            </section>
          </main>

          {toast && toast.text && (
            <div className={`toast ${toast.warn ? "warn" : ""}`}>{toast.text}</div>
          )}

          <footer className="text-center text-gray-500 text-sm mt-6 py-4 border-t">
            ¬© 2025 Recomendaciones de Aar√≥n ‚Äî Versi√≥n 50.7
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>